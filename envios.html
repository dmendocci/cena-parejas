<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Despacho y Reenv√≠o QRs</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f3; padding: 20px; color: #333; }
        .container { max-width: 600px; margin: 0 auto; }
        h1 { color: #2c3e50; text-align: center; font-size: 1.5rem; margin-bottom: 20px; }
        
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .inp-search { flex: 1; padding: 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; }
        .btn-search { padding: 15px 20px; background: #2c3e50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        .btn-load { width: 100%; padding: 15px; background: #741b47; color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; font-weight: bold; margin-bottom: 20px; }
        .btn-load:hover { background: #5c1538; }

        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; border-left: 5px solid #d4af37; animation: fadeIn 0.3s; position: relative; }
        .card.pagado { border-left-color: #27ae60; background: #f9fff9; }
        
        .badge { position: absolute; top: 10px; right: 10px; font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; font-weight: bold; }
        .badge-pendiente { background: #ffeeba; color: #856404; }
        .badge-pagado { background: #d4edda; color: #155724; }

        .names { font-size: 1.2rem; font-weight: bold; color: #741b47; margin-bottom: 15px; text-align: center; }
        
        .wa-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        
        .btn-wa { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; border-radius: 8px; text-decoration: none; color: white; font-weight: bold; font-size: 0.9rem; text-align: center; min-height: 70px; transition: 0.3s; border: 1px solid transparent; }
        .wa-man { background: #2980b9; }
        .wa-woman { background: #8e44ad; }
        .wa-man:hover { background: #21618c; }
        .wa-woman:hover { background: #71368a; }
        .btn-wa.enviado { background: #4a4a4a; border: 1px solid #333; }
        .no-phone { background: #95a5a6; cursor: not-allowed; opacity: 0.6; pointer-events: none; }
        
        .btn-done { width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: bold; }
        
        .timestamp { font-size: 0.75rem; color: #f1c40f; margin-top: 5px; font-weight: normal; }
        .loading { text-align: center; color: #777; font-style: italic; }
        .empty { text-align: center; padding: 30px; color: #aaa; background: white; border-radius: 8px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h1>üì§ Env√≠o de Pases</h1>
    
    <button class="btn-load" onclick="cargarPendientes()">üîÑ Forzar Sincronizaci√≥n y Recarga</button>

    <div class="search-box">
        <input type="text" id="txtBuscar" class="inp-search" placeholder="Buscar nombre..." onkeypress="handleEnter(event)">
        <button class="btn-search" onclick="buscarPersona()">üîç Buscar</button>
    </div>

    <div id="listaResultados"></div>
</div>

<script>
    // ‚úÖ TU URL NUEVA:
    const API_URL = "https://script.google.com/macros/s/AKfycbz-erGjGqH4CGGz7E8CY3GmCsBjsms0bkHSx169VYfvMsHle0vrSvcL8ik6DDE_HhgO5w/exec";

    // üöÄ ESTO SE EJECUTA AL ABRIR LA P√ÅGINA
    window.onload = function() {
        console.log("Iniciando carga autom√°tica...");
        cargarPendientes();
    };

    function cargarPendientes() {
        document.getElementById('txtBuscar').value = ""; 
        buscarAPI("listar_envios", {});
    }

    function buscarPersona() {
        const txt = document.getElementById('txtBuscar').value.trim();
        if(!txt) { alert("Escribe un nombre"); return; }
        buscarAPI("buscar_pareja", { texto: txt });
    }

    function handleEnter(e) {
        if(e.key === "Enter") buscarPersona();
    }

    function buscarAPI(accion, params) {
        const cont = document.getElementById('listaResultados');
        
        // Mensaje diferente si es carga inicial (que incluye sync)
        if(accion === "listar_envios") {
            cont.innerHTML = '<div class="loading">‚öôÔ∏è <b>Sincronizando con Tabla Maestra...</b><br>Leyendo nuevos registros... esto puede tardar unos segundos.</div>';
        } else {
            cont.innerHTML = '<div class="loading">‚è≥ Consultando...</div>';
        }

        const url = new URL(API_URL);
        url.searchParams.append("accion", accion);
        for (const key in params) url.searchParams.append(key, params[key]);

        fetch(url)
        .then(res => res.json())
        .then(data => {
            if(data.result === 'success') {
                renderizar(data.message);
            } else {
                cont.innerHTML = `<div class="empty">‚ùå Error: ${data.message}</div>`;
            }
        })
        .catch(e => cont.innerHTML = `<div class="empty">‚ùå Error de conexi√≥n</div>`);
    }

    function renderizar(lista) {
        const cont = document.getElementById('listaResultados');
        cont.innerHTML = "";

        if(lista.length === 0) {
            cont.innerHTML = `<div class="empty">‚ú® Todo al d√≠a. No hay nuevos pagos pendientes.</div>`;
            return;
        }

        lista.forEach(item => {
            const esPagado = item.estado === "Pagado";
            const claseCard = esPagado ? "card pagado" : "card";
            const badge = esPagado 
                ? `<div class="badge badge-pagado">‚úî PAGADO</div>` 
                : `<div class="badge badge-pendiente">‚è≥ PENDIENTE DE ENV√çO</div>`;

            const card = document.createElement('div');
            card.className = claseCard;
            card.id = `card-${item.fila}`;
            
            const msg = `¬°Hola! Su registro a la cena romantica: "Amor que prevalece" se ha procesado satisfactoriamente.\n\nPara encontrar su codigo QR:\n${item.link}\n\n¬°Los esperamos!`;
            const encMsg = encodeURIComponent(msg);
            
            let t1 = limpiarTel(item.tel1);
            let t2 = limpiarTel(item.tel2);
            
            let btnMan = t1 
                ? `<a href="https://wa.me/${t1}?text=${encMsg}" target="_blank" class="btn-wa wa-man" onclick="marcarEnviado(this)"><span>üì≤ Esposo</span><small>${item.esposo.split(' ')[0]}</small></a>`
                : `<div class="btn-wa no-phone">üö´ Sin Tel<br><small>Esposo</small></div>`;

            let btnWoman = t2
                ? `<a href="https://wa.me/${t2}?text=${encMsg}" target="_blank" class="btn-wa wa-woman" onclick="marcarEnviado(this)"><span>üì≤ Esposa</span><small>${item.esposa.split(' ')[0]}</small></a>`
                : `<div class="btn-wa no-phone">üö´ Sin Tel<br><small>Esposa</small></div>`;

            let btnFinalizar = esPagado 
                ? `<div style="text-align:center; color:#27ae60; font-weight:bold; margin-top:10px;">‚úÖ QR ya generado</div>`
                : `<button class="btn-done" onclick="marcarPagado(${item.fila}, '${item.link}', this)">‚úÖ Finalizar (Marcar Pagado)</button>`;

            card.innerHTML = `
                ${badge}
                <div class="names">${item.esposo} & ${item.esposa}</div>
                <div class="wa-grid">${btnMan}${btnWoman}</div>
                ${btnFinalizar}
            `;
            cont.appendChild(card);
        });
    }

    function marcarEnviado(btn) {
        const ahora = new Date();
        const fecha = ahora.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
        const hora = ahora.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        btn.classList.add('enviado');
        if(!btn.innerHTML.includes("Enviado")) { 
            btn.innerHTML += `<div class="timestamp">‚úî Reenviado ${fecha} ${hora}</div>`;
        }
    }

    function marcarPagado(fila, link, btn) {
        if(!confirm("¬øMarcar como COMPLETADO?")) return;
        btn.disabled = true; btn.innerText = "‚è≥ Guardando..."; btn.style.backgroundColor = "#999";
        
        const form = new URLSearchParams();
        form.append('accion', 'marcar_enviado');
        form.append('fila', fila);
        form.append('link', link);

        fetch(API_URL, { method: 'POST', body: form })
        .then(res => res.json())
        .then(data => {
            if(data.result === 'success') {
                const card = document.getElementById(`card-${fila}`);
                card.style.opacity = '0';
                setTimeout(() => card.remove(), 300);
            } else {
                alert("Error: " + data.message);
                btn.disabled = false;
            }
        });
    }

    function limpiarTel(tel) {
        if(!tel) return null;
        let t = tel.toString().replace(/\D/g, '');
        if(t.length < 8) return null;
        if(t.length === 8) return "504" + t;
        return t;
    }
</script>

</body>
</html>
