<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>Matriz de Env√≠os QR (V17)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f7; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 20px; }

        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .inp-search { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 6px; }
        .btn-search { padding: 12px 20px; background: #2c3e50; color: white; border: none; border-radius: 6px; cursor: pointer; }

        .btn-load { width: 100%; padding: 12px; background: #741b47; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-bottom: 20px; }
        .btn-load:hover { background: #5c1538; }

        /* TABLA MATRIZ */
        .tabla-matriz { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .tabla-matriz th { background: #34495e; color: white; padding: 15px; text-align: left; font-weight: 600; }
        .tabla-matriz td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .tabla-matriz tr:last-child td { border-bottom: none; }
        .tabla-matriz tr:hover { background-color: #f9f9f9; }

        .col-nombres { width: 40%; font-size: 1.1rem; color: #741b47; font-weight: bold; }
        .col-btn { width: 30%; text-align: center; }

        .btn-send {
            display: inline-block; width: 90%; padding: 10px 5px;
            background-color: #27ae60; color: white;
            text-decoration: none; border-radius: 6px; font-weight: bold; font-size: 0.9rem;
            transition: 0.2s; text-align: center; border: 1px solid transparent;
        }
        .btn-send:hover { background-color: #219150; transform: translateY(-1px); }

        .btn-send.enviado {
            background-color: #bdc3c7; color: #7f8c8d;
            border: 1px solid #bdc3c7; cursor: default; pointer-events: none;
        }
        .no-phone { background-color: #ecf0f1; color: #bdc3c7; cursor: not-allowed; pointer-events: none; }

        .loading { text-align: center; padding: 20px; font-style: italic; color: #777; }
        .empty { text-align: center; padding: 30px; color: #aaa; background: white; border-radius: 8px; }
        .fade-out { opacity: 0; transition: opacity 0.5s ease-out; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìã Matriz de Env√≠os QR</h1>
    <button class="btn-load" onclick="cargarPendientes()">üîÑ Refrescar Datos (Sincronizaci√≥n)</button>

    <div class="search-box">
        <input type="text" id="txtBuscar" class="inp-search" placeholder="Buscar pareja..." onkeypress="handleEnter(event)">
        <button class="btn-search" onclick="buscarPersona()">üîç Buscar</button>
    </div>

    <div id="contenedorTabla"></div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz-erGjGqH4CGGz7E8CY3GmCsBjsms0bkHSx169VYfvMsHle0vrSvcL8ik6DDE_HhgO5w/exec";

    window.onload = function() { cargarPendientes(); };

    function cargarPendientes() {
        document.getElementById('txtBuscar').value = "";
        buscarAPI("listar_envios", {});
    }

    function buscarPersona() {
        const txt = document.getElementById('txtBuscar').value.trim();
        if(!txt) { alert("Escribe un nombre"); return; }
        buscarAPI("buscar_pareja", { texto: txt });
    }

    function handleEnter(e) { if(e.key === "Enter") buscarPersona(); }

    function buscarAPI(accion, params) {
        const cont = document.getElementById('contenedorTabla');
        cont.innerHTML = '<div class="loading">‚è≥ Consultando servidor...</div>';

        // TRUCO ANTI-CACH√â: Agregamos un timestamp √∫nico a la URL
        const uniqueId = new Date().getTime(); 
        const url = new URL(API_URL);
        url.searchParams.append("accion", accion);
        url.searchParams.append("_t", uniqueId); // <--- ESTO FUERZA LA RECARGA

        for (const key in params) url.searchParams.append(key, params[key]);

        // Configuraci√≥n para ignorar cach√© del navegador
        fetch(url, { cache: "no-store" }) 
        .then(res => res.json())
        .then(data => {
            if(data.result === 'success') {
                renderizarTabla(data.message);
            } else {
                cont.innerHTML = `<div class="empty">‚ùå Error: ${data.message}</div>`;
            }
        })
        .catch(e => cont.innerHTML = `<div class="empty">‚ùå Error de conexi√≥n</div>`);
    }

    function renderizarTabla(lista) {
        const cont = document.getElementById('contenedorTabla');
        cont.innerHTML = "";

        if(lista.length === 0) {
            cont.innerHTML = `<div class="empty">‚ú® Todo listo. No hay pendientes.</div>`;
            return;
        }

        let html = `
        <table class="tabla-matriz">
            <thead>
                <tr>
                    <th>Pareja</th>
                    <th>Env√≠o Esposo</th>
                    <th>Env√≠o Esposa</th>
                </tr>
            </thead>
            <tbody>
        `;

        lista.forEach(item => {
            // El link viene directo de la base de datos (Col Q)
            const msg = `¬°Hola! Su registro a la cena rom√°ntica: "Amor que prevalece" se ha procesado satisfactoriamente.\n\nPara encontrar su c√≥digo QR:\n${item.link}\n\n¬°Los esperamos!`;
            const encMsg = encodeURIComponent(msg);
            
            let t1 = limpiarTel(item.tel1);
            let t2 = limpiarTel(item.tel2);
            const esCompleto = item.yaEnviado === true;

            // BOT√ìN ESPOSO
            let btnMan = "";
            if(t1) {
                let claseExtra = esCompleto ? "enviado" : "";
                let textoBtn = esCompleto ? "‚úî Ya Enviado" : "üì≤ Enviar QR";
                btnMan = `<a href="https://wa.me/${t1}?text=${encMsg}" target="_blank" 
                             class="btn-send ${claseExtra}" 
                             id="btn-man-${item.fila}"
                             onclick="registrarEnvio(this, ${item.fila}, 'man')">
                             ${textoBtn} <br><small>${item.esposo.split(' ')[0]}</small>
                          </a>`;
            } else {
                btnMan = `<div class="btn-send no-phone">üö´ Sin Tel</div>`;
            }

            // BOT√ìN ESPOSA
            let btnWoman = "";
            if(t2) {
                let claseExtra = esCompleto ? "enviado" : "";
                let textoBtn = esCompleto ? "‚úî Ya Enviado" : "üì≤ Enviar QR";
                btnWoman = `<a href="https://wa.me/${t2}?text=${encMsg}" target="_blank" 
                               class="btn-send ${claseExtra}" 
                               id="btn-woman-${item.fila}"
                               onclick="registrarEnvio(this, ${item.fila}, 'woman')">
                               ${textoBtn} <br><small>${item.esposa.split(' ')[0]}</small>
                            </a>`;
            } else {
                btnWoman = `<div class="btn-send no-phone">üö´ Sin Tel</div>`;
            }

            html += `
                <tr id="fila-${item.fila}">
                    <td class="col-nombres">${item.esposo} <br>&<br> ${item.esposa}</td>
                    <td class="col-btn">${btnMan}</td>
                    <td class="col-btn">${btnWoman}</td>
                </tr>
            `;
        });

        html += `</tbody></table>`;
        cont.innerHTML = html;
    }

    function registrarEnvio(btn, fila, quien) {
        if(btn.classList.contains('enviado')) return;
        
        btn.classList.add('enviado');
        const nombre = btn.querySelector('small').innerText;
        btn.innerHTML = `‚úî Enviado<br><small>${nombre}</small>`;

        const idOtro = (quien === 'man') ? `btn-woman-${fila}` : `btn-man-${fila}`;
        const btnOtro = document.getElementById(idOtro);

        let otroListo = false;
        if (!btnOtro) otroListo = true; 
        else if (btnOtro.classList.contains('enviado') || btnOtro.classList.contains('no-phone')) otroListo = true;

        if (otroListo) {
            guardarEnBackend(fila);
        }
    }

    function guardarEnBackend(fila) {
        const form = new URLSearchParams();
        form.append('accion', 'marcar_completo');
        form.append('fila', fila);

        fetch(API_URL, { method: 'POST', body: form })
        .then(res => res.json())
        .then(data => {
            if(data.result === 'success') {
                const tr = document.getElementById(`fila-${fila}`);
                if(!document.getElementById('txtBuscar').value) {
                    tr.classList.add('fade-out');
                    setTimeout(() => tr.remove(), 600);
                }
            }
        });
    }

    function limpiarTel(tel) {
        if(!tel) return null;
        let t = tel.toString().replace(/\D/g, '');
        if(t.length < 8) return null;
        if(t.length === 8) return "504" + t;
        return t;
    }
</script>

</body>
</html>
