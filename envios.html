<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Despacho QRs - Matriz</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f7; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; } /* M√°s ancho para la tabla */
        
        h1 { color: #2c3e50; text-align: center; margin-bottom: 20px; }

        /* BUSCADOR */
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .inp-search { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 6px; }
        .btn-search { padding: 12px 20px; background: #2c3e50; color: white; border: none; border-radius: 6px; cursor: pointer; }

        .btn-load { width: 100%; padding: 12px; background: #741b47; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-bottom: 20px; }
        .btn-load:hover { background: #5c1538; }

        /* --- ESTILOS DE LA MATRIZ (TABLA) --- */
        .tabla-matriz { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .tabla-matriz th { background: #34495e; color: white; padding: 15px; text-align: left; font-weight: 600; }
        .tabla-matriz td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .tabla-matriz tr:last-child td { border-bottom: none; }
        .tabla-matriz tr:hover { background-color: #f9f9f9; }

        .col-nombres { width: 40%; font-size: 1.1rem; color: #741b47; font-weight: bold; }
        .col-btn { width: 30%; text-align: center; }

        /* --- BOTONES DE ENV√çO --- */
        .btn-send {
            display: inline-block;
            width: 90%;
            padding: 10px 5px;
            background-color: #27ae60; /* VERDE */
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.9rem;
            transition: 0.2s;
            text-align: center;
            border: 1px solid transparent;
        }
        .btn-send:hover { background-color: #219150; transform: translateY(-1px); }

        /* ESTADO: ENVIADO (GRIS) */
        .btn-send.enviado {
            background-color: #bdc3c7; /* GRIS CLARO */
            color: #7f8c8d;
            border: 1px solid #bdc3c7;
            cursor: default;
            pointer-events: none; /* Ya no se puede clicar */
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        
        /* ESTADO: SIN TEL√âFONO */
        .no-phone {
            background-color: #ecf0f1;
            color: #bdc3c7;
            cursor: not-allowed;
            pointer-events: none;
        }

        .check-icon { font-size: 1.1em; margin-right: 5px; }
        .loading { text-align: center; padding: 20px; font-style: italic; color: #777; }
        .empty { text-align: center; padding: 30px; color: #aaa; background: white; border-radius: 8px; }

        /* Animaci√≥n para cuando desaparece la fila */
        .fade-out { opacity: 0; transition: opacity 0.5s ease-out; }

    </style>
</head>
<body>

<div class="container">
    <h1>üìã Matriz de Env√≠os QR</h1>
    
    <button class="btn-load" onclick="cargarPendientes()">üîÑ Sincronizar y Ver Pendientes</button>

    <div class="search-box">
        <input type="text" id="txtBuscar" class="inp-search" placeholder="Buscar pareja..." onkeypress="handleEnter(event)">
        <button class="btn-search" onclick="buscarPersona()">üîç Buscar</button>
    </div>

    <div id="contenedorTabla"></div>
</div>

<script>
    // ‚ö†Ô∏è PEGA AQU√ç TU URL NUEVA DE APPS SCRIPT
    const API_URL = "https://script.google.com/macros/s/AKfycbz-erGjGqH4CGGz7E8CY3GmCsBjsms0bkHSx169VYfvMsHle0vrSvcL8ik6DDE_HhgO5w/exec";

    window.onload = function() { cargarPendientes(); };

    function cargarPendientes() {
        document.getElementById('txtBuscar').value = "";
        buscarAPI("listar_envios", {});
    }

    function buscarPersona() {
        const txt = document.getElementById('txtBuscar').value.trim();
        if(!txt) { alert("Escribe un nombre"); return; }
        buscarAPI("buscar_pareja", { texto: txt });
    }

    function handleEnter(e) { if(e.key === "Enter") buscarPersona(); }

    function buscarAPI(accion, params) {
        const cont = document.getElementById('contenedorTabla');
        if(accion === "listar_envios") cont.innerHTML = '<div class="loading">‚öôÔ∏è Sincronizando datos...</div>';
        else cont.innerHTML = '<div class="loading">‚è≥ Buscando...</div>';

        const url = new URL(API_URL);
        url.searchParams.append("accion", accion);
        for (const key in params) url.searchParams.append(key, params[key]);

        fetch(url)
        .then(res => res.json())
        .then(data => {
            if(data.result === 'success') {
                renderizarTabla(data.message, accion === "buscar_pareja");
            } else {
                cont.innerHTML = `<div class="empty">‚ùå Error: ${data.message}</div>`;
            }
        })
        .catch(e => cont.innerHTML = `<div class="empty">‚ùå Error de conexi√≥n</div>`);
    }

    function renderizarTabla(lista, esBusqueda) {
        const cont = document.getElementById('contenedorTabla');
        cont.innerHTML = "";

        if(lista.length === 0) {
            cont.innerHTML = `<div class="empty">‚ú® Todo listo. No hay pendientes.</div>`;
            return;
        }

        // Crear Estructura de Tabla
        let html = `
        <table class="tabla-matriz">
            <thead>
                <tr>
                    <th>Pareja</th>
                    <th>Env√≠o Esposo</th>
                    <th>Env√≠o Esposa</th>
                </tr>
            </thead>
            <tbody>
        `;

        lista.forEach(item => {
            // Preparar mensaje y tel√©fonos
            const msg = `¬°Hola! Su registro a la cena romantica: "Amor que prevalece" se ha procesado satisfactoriamente.\n\nPara encontrar su codigo QR:\n${item.link}\n\n¬°Los esperamos!`;
            const encMsg = encodeURIComponent(msg);
            let t1 = limpiarTel(item.tel1);
            let t2 = limpiarTel(item.tel2);

            // Determinar si ya est√° todo "Completo" (para b√∫squedas)
            const esCompleto = item.yaEnviado === true;

            // BOT√ìN ESPOSO
            let btnMan = "";
            if(t1) {
                // Si es b√∫squeda y ya estaba enviado, lo mostramos gris. Si no, verde.
                let claseExtra = esCompleto ? "enviado" : "";
                let textoBtn = esCompleto ? "‚úî Ya Enviado" : "üì≤ Enviar QR";
                btnMan = `<a href="https://wa.me/${t1}?text=${encMsg}" target="_blank" 
                             class="btn-send ${claseExtra}" 
                             id="btn-man-${item.fila}"
                             onclick="registrarEnvio(this, ${item.fila}, 'man')">
                             ${textoBtn} <br><small>${item.esposo.split(' ')[0]}</small>
                          </a>`;
            } else {
                btnMan = `<div class="btn-send no-phone">üö´ Sin Tel</div>`;
            }

            // BOT√ìN ESPOSA
            let btnWoman = "";
            if(t2) {
                let claseExtra = esCompleto ? "enviado" : "";
                let textoBtn = esCompleto ? "‚úî Ya Enviado" : "üì≤ Enviar QR";
                btnWoman = `<a href="https://wa.me/${t2}?text=${encMsg}" target="_blank" 
                               class="btn-send ${claseExtra}" 
                               id="btn-woman-${item.fila}"
                               onclick="registrarEnvio(this, ${item.fila}, 'woman')">
                               ${textoBtn} <br><small>${item.esposa.split(' ')[0]}</small>
                            </a>`;
            } else {
                btnWoman = `<div class="btn-send no-phone">üö´ Sin Tel</div>`;
            }

            html += `
                <tr id="fila-${item.fila}">
                    <td class="col-nombres">${item.esposo} <br>&<br> ${item.esposa}</td>
                    <td class="col-btn">${btnMan}</td>
                    <td class="col-btn">${btnWoman}</td>
                </tr>
            `;
        });

        html += `</tbody></table>`;
        cont.innerHTML = html;
    }

    // --- L√ìGICA DE ACTUALIZACI√ìN AUTOM√ÅTICA ---
    function registrarEnvio(btn, fila, quien) {
        // 1. Cambiar visualmente el bot√≥n clickeado
        if(btn.classList.contains('enviado')) return; // Evitar doble clic
        
        btn.classList.add('enviado');
        // Mantener el nombre abajo, cambiar solo el texto de arriba
        const nombre = btn.querySelector('small').innerText;
        btn.innerHTML = `‚úî Enviado<br><small>${nombre}</small>`;

        // 2. Verificar estado del OTRO bot√≥n
        const idOtro = (quien === 'man') ? `btn-woman-${fila}` : `btn-man-${fila}`;
        const btnOtro = document.getElementById(idOtro);

        // CONDICIONES PARA COMPLETAR:
        // A. El otro bot√≥n ya est√° enviado (tiene clase 'enviado')
        // B. O el otro bot√≥n NO existe (porque no ten√≠a tel√©fono, es clase 'no-phone')
        let otroListo = false;
        
        if (!btnOtro) {
            // Caso raro, pero asumimos listo si no hay bot√≥n
            otroListo = true; 
        } else if (btnOtro.classList.contains('enviado') || btnOtro.classList.contains('no-phone')) {
            otroListo = true;
        }

        // 3. Si AMBOS est√°n listos, avisar al Backend
        if (otroListo) {
            console.log(`Fila ${fila} completa. Guardando en BD...`);
            guardarEnBackend(fila);
        }
    }

    function guardarEnBackend(fila) {
        const form = new URLSearchParams();
        form.append('accion', 'marcar_completo');
        form.append('fila', fila);

        fetch(API_URL, { method: 'POST', body: form })
        .then(res => res.json())
        .then(data => {
            if(data.result === 'success') {
                // Opcional: Desvanecer la fila porque ya terminamos con ella
                const tr = document.getElementById(`fila-${fila}`);
                // Si estamos en "Pendientes" (no b√∫squeda), la quitamos
                if(!document.getElementById('txtBuscar').value) {
                    tr.classList.add('fade-out');
                    setTimeout(() => tr.remove(), 600);
                }
            }
        });
    }

    function limpiarTel(tel) {
        if(!tel) return null;
        let t = tel.toString().replace(/\D/g, '');
        if(t.length < 8) return null;
        if(t.length === 8) return "504" + t;
        return t;
    }
</script>

</body>
</html>
