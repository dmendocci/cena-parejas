<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Cena Parejas</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .btn-recordatorio { background-color: #dc2626 !important; color: white !important; border: 1px solid #b91c1c !important; }
        .btn-recordatorio:hover { background-color: #b91c1c !important; }
        .btn-enviado { background-color: #9ca3af !important; color: white !important; cursor: not-allowed !important; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <script>
        // =================================================================
        // üëá URL ACTUALIZADA üëá
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzpjWmqOGqN0g7FpLcokjemqf9tLOsgYjhEBFOK33I4fDjNBG3WpbKrUI6L4u89h0syHA/exec"; 
        // =================================================================
        
        const MENSAJES_PAGO = [
            "¬°Hola [NOMBRE]! Bendiciones. Les saludamos de la pastoral de matrimonios. Hoy queremos recordarles gentilmente que tenemos pendiente su paso final del pago de su inscripci√≥n para la Cena 'Amor que Permanece'. Estamos muy contentos de poder contar con ustedes. Agradecer√≠amos si pueden realizarlo el d√≠a de hoy. ¬°Gracias!",
            "¬°Bendiciones [NOMBRE]! Ya falta poco para nuestra noche especial. Queremos que todo est√© perfecto para usted y su pareja. Le enviamos este recordatorio amistoso solicitando puedan realizar el pago; de ser posible hoy, por razones de log√≠stica. ¬°Ser√° un tiempo de mucha bendici√≥n para su matrimonio!",
            "¬°Hola [NOMBRE]! Esperamos que est√©n muy bien. Por razones de log√≠stica; necesitamos realicen su pago cuanto antes. ¬øSi han tenido alg√∫n inconveniente o necesitan ayuda con los datos de dep√≥sito? Estamos para servirles.",
            "¬°Saludos hermanos! Un recordatorio cordial para solicitar nos apoyen con el env√≠o de su aporte para nuestra cena rom√°ntica. Disfrutaremos de una noche grandiosa y su presencia es muy valiosa. ¬°Bendiciones!",
            "¬°Hola [NOMBRE]! Disculpen la insistencia, solo queremos asegurarnos de que no pierdan la oportunidad de estar presente en nuestra cena el 13 de febrero, por lo cual, solicitamos puedan realizar su pago pendiente. Anticiparemos verles all√≠ para celebrar juntos."
        ];
    </script>

    <div class="max-w-7xl mx-auto p-4">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-lg shadow-md border-t-4 border-red-700">
            <div class="mb-4 md:mb-0">
                <h1 class="text-2xl font-bold text-red-800 flex items-center gap-2">
                    <i class="fas fa-heart text-red-600"></i> Control de Asistencia
                </h1>
                <p class="text-sm text-gray-500">Cena "Amor que Permanece" (Tabla Directa)</p>
            </div>
            <div class="flex gap-3">
                <button onclick="cargarDatos()" class="bg-blue-600 text-white px-5 py-2 rounded-lg shadow hover:bg-blue-700 flex items-center gap-2">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
            </div>
        </header>

        <div class="mb-6 flex flex-col md:flex-row gap-4">
            <div class="relative flex-grow">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-gray-400"></i></span>
                <input type="text" id="searchInput" onkeyup="filtrarTabla()" placeholder="Buscar..." class="w-full pl-10 p-3 rounded-lg border border-gray-300 shadow-sm focus:ring-2 focus:ring-red-400 focus:border-transparent outline-none transition">
            </div>
            <div class="w-full md:w-1/4">
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><i class="fas fa-filter text-gray-500"></i></span>
                    <select id="filterStatus" onchange="filtrarTabla()" class="w-full pl-10 p-3 rounded-lg border border-gray-300 shadow-sm focus:ring-2 focus:ring-red-400 focus:border-transparent outline-none appearance-none bg-white cursor-pointer">
                        <option value="TODOS">Todas las Parejas</option>
                        <option value="PENDIENTE">‚ö†Ô∏è Pendientes</option>
                        <option value="PAGADO">‚úÖ Pagados</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full leading-normal">
                    <thead>
                        <tr class="bg-gray-100 text-left text-xs font-bold text-gray-600 uppercase tracking-wider border-b border-gray-200">
                            <th class="px-5 py-3 w-1/3">Pareja</th>
                            <th class="px-5 py-3 text-center w-1/6">Estado</th>
                            <th class="px-5 py-3 text-center w-1/3">Acciones</th>
                            <th class="px-5 py-3 text-center w-1/6">Seguimiento</th>
                        </tr>
                    </thead>
                    <tbody id="tablaCuerpo" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div id="emptyState" class="hidden p-10 text-center text-gray-500">
                <p>No se encontraron datos. Verifique la conexi√≥n.</p>
            </div>
        </div>

        <div id="loader" class="fixed top-0 left-0 w-full h-full bg-white bg-opacity-90 flex flex-col justify-center items-center z-50 hidden backdrop-filter backdrop-blur-sm">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-16 w-16 mb-4"></div>
            <h2 class="text-xl font-semibold text-gray-700">Cargando...</h2>
        </div>
    </div>

    <script>
        let datosGlobales = [];

        function obtenerLinkWhatsApp(telefono, mensaje) {
            let tel = telefono ? telefono.toString().replace(/\D/g, '') : "";
            if (tel.length === 8) tel = '504' + tel;
            if (tel.length < 5) return "#"; // Tel√©fono inv√°lido
            
            const esMovil = /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent);
            const urlBase = esMovil ? "https://api.whatsapp.com/send" : "https://web.whatsapp.com/send";
            return `${urlBase}?phone=${tel}&text=${encodeURIComponent(mensaje)}`;
        }

        async function cargarDatos() {
            mostrarLoader(true);
            try {
                const response = await fetch(`${SCRIPT_URL}?accion=listar_envios`);
                const data = await response.json();
                
                if (data.result === "success") {
                    datosGlobales = data.message;
                    filtrarTabla();
                } else {
                    alert("‚ö†Ô∏è Error del servidor: " + data.message);
                }
            } catch (e) {
                console.error(e);
                alert("‚ùå Error de conexi√≥n. Verifique la URL del Script.");
            } finally {
                mostrarLoader(false);
            }
        }

        function renderizarTabla(lista) {
            const tbody = document.getElementById("tablaCuerpo");
            const emptyState = document.getElementById("emptyState");
            tbody.innerHTML = "";

            if (lista.length === 0) { emptyState.classList.remove("hidden"); return; }
            else { emptyState.classList.add("hidden"); }

            lista.forEach(item => {
                const tr = document.createElement("tr");
                tr.className = "hover:bg-red-50 transition duration-150";

                // 1. NOMBRES
                let htmlPareja = `
                    <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-2"><span class="font-bold text-gray-900">${item.esposo}</span></div>
                        <div class="text-xs text-gray-500 ml-1"><i class="fab fa-whatsapp text-green-500"></i> ${item.tel1 || '---'}</div>
                        <div class="border-t border-gray-100 my-1"></div>
                        <div class="flex items-center gap-2"><span class="font-bold text-gray-900">${item.esposa}</span></div>
                        <div class="text-xs text-gray-500 ml-1"><i class="fab fa-whatsapp text-green-500"></i> ${item.tel2 || '---'}</div>
                    </div>`;

                // 2. ESTADO PAGO
                let htmlPago = item.tienePago 
                    ? `<span class="px-3 py-1 text-xs font-bold rounded-full bg-green-100 text-green-800 border border-green-200">PAGADO</span>`
                    : `<span class="px-3 py-1 text-xs font-bold rounded-full bg-red-100 text-red-800 border border-red-200">PENDIENTE</span>`;

                // 3. ACCIONES Y 4. SEGUIMIENTO (L√≥gica combinada)
                let htmlAcciones = "";
                let htmlStatus = ""; // Por defecto vac√≠o

                if (item.tienePago) {
                    // === SI YA PAG√ì ===
                    // Acciones: Ver QR
                    htmlAcciones += `<div class="flex flex-col items-center gap-2">`;
                    if(item.qrUrl) {
                        htmlAcciones += `<a href="${item.qrUrl}" target="_blank" class="text-blue-600 text-xs font-bold underline">Ver QR</a>`;
                    }
                    htmlAcciones += `<div class="flex gap-2">`;
                    htmlAcciones += `<button onclick="enviarQR('${item.tel1}', '${item.esposo}', '${item.qrUrl}')" class="bg-green-600 text-white px-3 py-1 rounded text-xs">QR √âl</button>`;
                    htmlAcciones += `<button onclick="enviarQR('${item.tel2}', '${item.esposa}', '${item.qrUrl}')" class="bg-green-600 text-white px-3 py-1 rounded text-xs">QR Ella</button>`;
                    htmlAcciones += `</div></div>`;
                    
                    // Seguimiento: VAC√çO o mensaje de √©xito
                    htmlStatus = `<div class="text-center text-green-500 text-xs"><i class="fas fa-check"></i> Completado</div>`;

                } else {
                    // === SI NO HA PAGADO ===
                    // Acciones: Botones de Cobro
                    let intentos = item.followUpCount || 0;
                    let indiceMensaje = Math.min(intentos, MENSAJES_PAGO.length - 1);
                    let tituloMensaje = ["Est√°ndar", "Entusiasta", "Log√≠stico", "Breve", "√öltimo"][indiceMensaje];
                    
                    htmlAcciones += `
                    <div class="flex flex-col items-center bg-gray-50 p-2 rounded border border-gray-200 w-full">
                        <span class="text-red-800 font-bold text-[9px] uppercase mb-2">RECORDAR PAGO</span>
                        <div class="flex gap-2 mb-1">
                            <button onclick="enviarRecordatorio(${item.fila}, '${item.tel1}', '${item.esposo}', ${intentos}, this)" class="btn-recordatorio px-3 py-1 rounded text-xs font-bold transition">√âl</button>
                            <button onclick="enviarRecordatorio(${item.fila}, '${item.tel2}', '${item.esposa}', ${intentos}, this)" class="btn-recordatorio px-3 py-1 rounded text-xs font-bold transition">Ella</button>
                        </div>
                        <span class="text-[9px] text-gray-500 italic">Msj ${indiceMensaje + 1}: ${tituloMensaje}</span>
                    </div>`;

                    // Seguimiento: BARRA DE PROGRESO (Solo visible si debe)
                    let width = Math.min((intentos / 5) * 100, 100);
                    let colorBarra = intentos >= 4 ? "bg-red-500" : "bg-yellow-500";
                    htmlStatus = `
                        <div class="w-full max-w-[100px] mx-auto">
                            <div class="flex justify-between text-[9px] text-gray-500 mb-1">
                                <span>Nivel</span><span>${intentos}/5</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="${colorBarra} h-2 rounded-full" style="width: ${width}%"></div>
                            </div>
                        </div>`;
                }

                tr.innerHTML = `<td class="px-5 py-4 bg-white text-sm border-r border-gray-100">${htmlPareja}</td>
                                <td class="px-5 py-4 bg-white text-center border-r border-gray-100">${htmlPago}</td>
                                <td class="px-5 py-4 bg-white text-center border-r border-gray-100">${htmlAcciones}</td>
                                <td class="px-5 py-4 bg-white text-center">${htmlStatus}</td>`;
                tbody.appendChild(tr);
            });
        }

        function filtrarTabla() {
            const texto = document.getElementById("searchInput").value.toLowerCase();
            const estado = document.getElementById("filterStatus").value;
            const filtrados = datosGlobales.filter(item => {
                const matchTexto = (item.esposo && item.esposo.toLowerCase().includes(texto)) || 
                                   (item.esposa && item.esposa.toLowerCase().includes(texto));
                let matchEstado = true;
                if (estado === "PAGADO") matchEstado = item.tienePago === true;
                if (estado === "PENDIENTE") matchEstado = item.tienePago === false;
                return matchTexto && matchEstado;
            });
            renderizarTabla(filtrados);
        }

        function enviarQR(tel, nombre, url) {
            if(!url) { alert("‚ö†Ô∏è A√∫n no se ha generado el Link QR. Actualice la tabla."); return; }
            const msj = `¬°Hola ${nombre}! üëã Aqu√≠ tienes tu pase para la cena: ${url}`;
            window.open(obtenerLinkWhatsApp(tel, msj), '_blank');
        }

        function enviarRecordatorio(fila, tel, nombre, intentos, btn) {
            const msj = MENSAJES_PAGO[Math.min(intentos, MENSAJES_PAGO.length-1)].replace("[NOMBRE]", nombre);
            const link = obtenerLinkWhatsApp(tel, msj);
            
            if(link === "#") { alert("‚ö†Ô∏è Tel√©fono no v√°lido."); return; }
            
            window.open(link, '_blank');
            
            // Visual
            btn.classList.remove("btn-recordatorio");
            btn.classList.add("btn-enviado");
            btn.innerText = "Enviado";
            btn.disabled = true;

            // Servidor (sin esperar respuesta para no bloquear)
            fetch(`${SCRIPT_URL}?accion=registrar_envio&tipo=recordatorio&fila=${fila}`, {method: 'POST'});
        }

        function mostrarLoader(show) { document.getElementById("loader").classList.toggle("hidden", !show); }
        
        window.onload = cargarDatos;
    </script>
</body>
</html>
