<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Entrada - Cena Parejas</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        body { background-color: #1a202c; color: white; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; background: #000; }
        .success-screen { background-color: #22c55e; } /* Verde */
        .error-screen { background-color: #ef4444; }   /* Rojo */
        .warning-screen { background-color: #f59e0b; } /* Amarillo */
    </style>
</head>
<body class="flex flex-col h-screen">

    <div class="p-4 bg-gray-900 shadow-md z-10">
        <h1 class="text-xl font-bold text-center text-red-500">Scanner Entrada ❤️</h1>
        <p id="status-db" class="text-xs text-center text-gray-400 mt-1">Cargando base de datos...</p>
    </div>

    <div class="flex-grow flex flex-col items-center justify-start pt-4 px-4">
        <div id="reader" class="shadow-2xl border-4 border-gray-700"></div>
        
        <button onclick="reiniciarScanner()" class="mt-4 text-xs text-gray-400 underline">
            ¿Problemas con la cámara? Toca aquí
        </button>
    </div>

    <div id="result-overlay" class="fixed inset-0 hidden flex flex-col items-center justify-center text-center p-6 z-50">
        <div id="result-icon" class="text-8xl mb-4">✅</div>
        <h2 id="result-title" class="text-4xl font-bold mb-2">BIENVENIDOS</h2>
        <p id="result-name" class="text-2xl font-semibold">Carlos & María</p>
        <p id="result-msg" class="mt-4 text-lg opacity-90">Registro Confirmado</p>
        
        <button onclick="cerrarOverlay()" class="mt-10 bg-white text-gray-800 font-bold py-3 px-10 rounded-full shadow-lg text-xl">
            Siguiente Pareja
        </button>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const APPS_SCRIPT_URL = 'TU_URL_DEL_SCRIPT_AQUI'; // <--- ¡PEGA TU URL AQUÍ!

        let listaInvitados = [];
        let html5QrcodeScanner = null;
        let isScanning = true;

        // --- 1. CARGA DE DATOS ---
        async function cargarBaseDatos() {
            const statusEl = document.getElementById('status-db');
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?accion=listar_asistencia`);
                const data = await response.json();
                
                if (data.result === "success") {
                    listaInvitados = data.message;
                    statusEl.innerText = `Base de datos lista: ${listaInvitados.length} parejas.`;
                    statusEl.classList.remove('text-red-400');
                    statusEl.classList.add('text-green-400');
                } else {
                    throw new Error(data.message);
                }
            } catch (e) {
                statusEl.innerText = "Error cargando lista. Revisa internet.";
                statusEl.classList.add('text-red-400');
                console.error(e);
            }
        }

        // --- 2. LÓGICA DE NORMALIZACIÓN (EL SECRETO) ---
        // Esto quita acentos, "REGISTRO:", espacios extra y pasa a minúsculas
        function normalizar(texto) {
            if (!texto) return "";
            return texto.toString()
                .toLowerCase()
                .replace("registro:", "") // Quitamos el prefijo del QR
                .trim()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Quita tildes (á -> a)
                .replace(/\s+/g, " "); // Convierte dobles espacios en uno
        }

        // --- 3. PROCESAR QR ESCANEADO ---
        function onScanSuccess(decodedText, decodedResult) {
            if (!isScanning) return; // Evitar lecturas dobles rápidas

            // 1. Detener escaneo momentáneo
            isScanning = false; 
            if(html5QrcodeScanner) html5QrcodeScanner.pause();

            const qrLimpio = normalizar(decodedText);
            console.log("Escaneado (Raw):", decodedText);
            console.log("Escaneado (Limpio):", qrLimpio);

            // 2. BUSCAR EN LA LISTA
            // Buscamos si el string del QR está contenido en el nombre o viceversa
            const encontrado = listaInvitados.find(invitado => {
                const dbNombre = normalizar(invitado.nombres);
                // Coincidencia flexible:
                return dbNombre.includes(qrLimpio) || qrLimpio.includes(dbNombre);
            });

            // 3. MOSTRAR RESULTADO
            if (encontrado) {
                if (encontrado.asistio) {
                    mostrarPantalla("warning", "YA INGRESÓ", encontrado.nombres, "Esta pareja ya fue marcada antes.");
                } else {
                    mostrarPantalla("success", "BIENVENIDOS", encontrado.nombres, "Pase Válido");
                    registrarEntradaBackend(encontrado.fila); // Guardar en Google Sheets
                    encontrado.asistio = true; // Actualizar localmente para no dejar pasar doble
                }
            } else {
                mostrarPantalla("error", "NO ENCONTRADO", "QR: " + decodedText, "Verifique que sea de este evento.");
            }
        }

        function onScanFailure(error) {
            // Ruido normal del escáner, no hacer nada
        }

        // --- UI DEL RESULTADO ---
        function mostrarPantalla(tipo, titulo, nombre, mensaje) {
            const overlay = document.getElementById('result-overlay');
            const icon = document.getElementById('result-icon');
            
            overlay.className = "fixed inset-0 flex flex-col items-center justify-center text-center p-6 z-50 text-white";
            
            if (tipo === 'success') {
                overlay.classList.add('success-screen');
                icon.innerText = "✅";
                // Sonido de éxito (opcional)
                new Audio('https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg').play().catch(e=>{});
            } else if (tipo === 'error') {
                overlay.classList.add('error-screen');
                icon.innerText = "❌";
                // Sonido de error
                new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(e=>{});
            } else { // Warning
                overlay.classList.add('warning-screen');
                icon.innerText = "⚠️";
            }

            document.getElementById('result-title').innerText = titulo;
            document.getElementById('result-name').innerText = nombre;
            document.getElementById('result-msg').innerText = mensaje;
            
            overlay.classList.remove('hidden');
        }

        function cerrarOverlay() {
            document.getElementById('result-overlay').classList.add('hidden');
            isScanning = true;
            if(html5QrcodeScanner) html5QrcodeScanner.resume();
        }

        async function registrarEntradaBackend(fila) {
            try {
                await fetch(`${APPS_SCRIPT_URL}?accion=marcar_asistencia&fila=${fila}`, {method: 'POST'});
            } catch (e) {
                console.error("No se pudo guardar online (pero ya entró localmente)", e);
            }
        }

        // --- INICIALIZACIÓN DE CÁMARA ---
        function iniciarScanner() {
            // Usamos Html5QrcodeScanner que trae UI para elegir cámara
            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader", 
                { fps: 10, qrbox: {width: 250, height: 250}, aspectRatio: 1.0 },
                /* verbose= */ false);
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        }

        function reiniciarScanner() {
           location.reload();
        }

        // Arrancar
        window.onload = function() {
            cargarBaseDatos();
            iniciarScanner();
        };

    </script>
</body>
</html>
