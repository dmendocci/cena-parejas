<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Entrada</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        body { background-color: #000; color: white; font-family: sans-serif; }
        #reader { width: 100%; border-radius: 0 0 20px 20px; overflow: hidden; border-bottom: 2px solid #333; }
        .success { background-color: #22c55e; } 
        .error { background-color: #ef4444; }   
        .warning { background-color: #f59e0b; } 
        button { padding: 10px 20px; border-radius: 8px; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div id="reader"></div>

    <div class="p-4 text-center">
        <p id="status-db" class="text-sm text-gray-400 animate-pulse">‚è≥ Descargando lista del portero...</p>
        <p class="text-xs text-gray-600 mt-2">Versi√≥n Frontend: Sin Filtros</p>
    </div>

    <div id="overlay" class="fixed inset-0 hidden flex flex-col items-center justify-center p-6 text-center z-50">
        <div id="icon" class="text-8xl mb-4"></div>
        <h2 id="title" class="text-4xl font-bold mb-2 uppercase"></h2>
        <p id="name" class="text-2xl font-semibold mb-2"></p>
        <p id="msg" class="text-lg opacity-90"></p>
        <button onclick="resetScanner()" class="bg-white text-black shadow-lg">SIGUIENTE</button>
    </div>

    <script>
        // =====================================================
        // ‚ö†Ô∏è PEGA AQU√ç LA URL DE TU SCRIPT (VERSION 2 FEB)
        // =====================================================
        const URL_SCRIPT = 'https://script.google.com/macros/s/AKfycbyBLSQ9UTUL9cD7CtwAb9ZqecvDKK2DN3XgJbZ4IMtADoucQpYG1Cm7xnuFIC28EzhI8Q/exec'; 
        // =====================================================

        let invitados = [];
        let scanner = null;
        let escaneando = true;

        // 1. EL "PORTERO" DESCARGA LA LISTA (SIN FILTROS RAROS)
        async function descargarLista() {
            const status = document.getElementById('status-db');
            try {
                // Pedimos la lista tal cual la usa envios.html
                const resp = await fetch(`${URL_SCRIPT}?accion=listar_todo`);
                const json = await resp.json();
                
                if (json.result === "success") {
                    // AQU√ç ESTABA EL ERROR ANTES: NO FILTRAMOS NADA
                    // Guardamos todo lo que tenga nombre, aunque sea fila vac√≠a con basura
                    invitados = json.message.map(p => ({
                        // Unimos nombres para buscar f√°cil
                        busqueda: normalizar(p.esposo + " " + p.esposa),
                        nombreMostar: `${p.esposo} & ${p.esposa}`,
                        fila: p.fila,
                        // Si el script viejo no manda "yaEntro", asumimos false
                        yaEntro: false 
                    }));

                    status.innerHTML = `‚úÖ <b>LISTO:</b> Portero tiene ${invitados.length} nombres.`;
                    status.className = "text-sm text-green-500 font-bold";
                    iniciarCamara();
                } else {
                    status.innerHTML = "‚ùå Error en datos.";
                }
            } catch (e) {
                status.innerHTML = "‚ùå Error de conexi√≥n.";
                console.error(e);
            }
        }

        // 2. LIMPIADOR DE TEXTO (QUITAR TILDES Y MAY√öSCULAS)
        function normalizar(txt) {
            if(!txt) return "";
            return txt.toString().toLowerCase()
                .replace("registro:", "") // Por si el QR dice "REGISTRO: Juan"
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Quitar tildes
                .replace(/[^a-z0-9 ]/g, "") // Quitar s√≠mbolos raros
                .trim();
        }

        // 3. CUANDO EL ESC√ÅNER LEE ALGO
        function alLeerQR(textoQR) {
            if (!escaneando) return;
            
            // Pausa visual
            escaneando = false; 
            if(scanner) scanner.pause();

            const qrLimpio = normalizar(textoQR);
            console.log("Buscando:", qrLimpio);

            // B√öSQUEDA FLEXIBLE
            // ¬øEl QR est√° en la lista? O ¬øLa lista est√° en el QR?
            const encontrado = invitados.find(p => {
                if(!p.busqueda) return false;
                return p.busqueda.includes(qrLimpio) || qrLimpio.includes(p.busqueda);
            });

            if (encontrado) {
                if (encontrado.yaEntro) {
                    mostrarResultado("warning", "‚ö†Ô∏è YA EST√Å DENTRO", encontrado.nombreMostar, "Ya se registr√≥ antes.");
                } else {
                    mostrarResultado("success", "‚úÖ ADELANTE", encontrado.nombreMostar, "Bienvenidos.");
                    // Marcar localmente
                    encontrado.yaEntro = true;
                    // Intentar avisar al servidor (sin esperar respuesta para no trabar)
                    avisarServidor(encontrado.fila);
                }
            } else {
                mostrarResultado("error", "üö´ NO ENCONTRADO", "QR Desconocido", "Verifique lista.");
            }
        }

        function avisarServidor(fila) {
            // Intenta marcar en Google Sheets. Si falla, no importa, ya entr√≥.
            fetch(`${URL_SCRIPT}?accion=marcar_asistencia&fila=${fila}`, {method: 'POST'}).catch(e=>console.log(e));
        }

        // 4. MOSTRAR PANTALLA DE COLORES
        function mostrarResultado(tipo, titulo, nombre, msg) {
            const overlay = document.getElementById('overlay');
            const icon = document.getElementById('icon');
            
            overlay.className = "fixed inset-0 flex flex-col items-center justify-center p-6 text-center z-50 text-white " + tipo;
            icon.innerText = (tipo === "success") ? "‚ú®" : (tipo === "warning" ? "‚úã" : "üö´");
            
            document.getElementById('title').innerText = titulo;
            document.getElementById('name').innerText = nombre;
            document.getElementById('msg').innerText = msg;
            
            overlay.classList.remove('hidden');
        }

        function resetScanner() {
            document.getElementById('overlay').classList.add('hidden');
            escaneando = true;
            if(scanner) scanner.resume();
        }

        function iniciarCamara() {
            scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
            scanner.render(alLeerQR, (err)=>{});
        }

        window.onload = descargarLista;

    </script>
</body>
</html>
