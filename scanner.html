<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Entrada - Cena Parejas</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        body { background-color: #1a202c; color: white; font-family: sans-serif; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; background: #000; margin-bottom: 20px; }
        
        /* Pantallas de resultados */
        .success-screen { background-color: #22c55e; } /* Verde */
        .error-screen { background-color: #ef4444; }   /* Rojo */
        .warning-screen { background-color: #f59e0b; } /* Amarillo */
        
        /* Ajuste del bot√≥n de la librer√≠a */
        #html5-qrcode-button-camera-stop, #html5-qrcode-button-camera-start {
            padding: 10px 20px; border-radius: 5px; background: #3b82f6; color: white; border: none; margin: 5px;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div class="p-4 bg-gray-900 shadow-md z-10 text-center">
        <h1 class="text-xl font-bold text-red-500">Scanner Entrada ‚ù§Ô∏è</h1>
        <p id="status-db" class="text-xs text-gray-400 mt-1 animate-pulse">Cargando lista de invitados...</p>
    </div>

    <div class="flex-grow flex flex-col items-center justify-start pt-4 px-4 overflow-y-auto">
        
        <div id="reader"></div>
        
        <div class="text-xs text-gray-500 text-center mt-2 px-4">
            Si no lee bien, selecciona otra c√°mara en el men√∫ de arriba ("Select Camera").
        </div>
    </div>

    <div id="result-overlay" class="fixed inset-0 hidden flex flex-col items-center justify-center text-center p-6 z-50">
        <div id="result-icon" class="text-8xl mb-4 font-bold"></div>
        <h2 id="result-title" class="text-4xl font-bold mb-2 uppercase drop-shadow-md"></h2>
        <p id="result-name" class="text-2xl font-semibold drop-shadow-sm text-white"></p>
        <p id="result-msg" class="mt-4 text-lg opacity-90 text-white"></p>
        
        <button onclick="cerrarOverlay()" class="mt-10 bg-white text-gray-900 font-bold py-4 px-10 rounded-full shadow-xl text-xl hover:scale-105 transition-transform">
            Escanear Siguiente
        </button>
    </div>

    <script>
        // ==========================================
        // ‚öôÔ∏è CONFIGURACI√ìN - PEGA TU URL AQU√ç
        // ==========================================
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyBLSQ9UTUL9cD7CtwAb9ZqecvDKK2DN3XgJbZ4IMtADoucQpYG1Cm7xnuFIC28EzhI8Q/exec'; 
        // ==========================================

        let listaInvitados = [];
        let html5QrcodeScanner = null;
        let isScanning = true;

        // --- 1. CARGA DE BASE DE DATOS ---
        async function cargarBaseDatos() {
            const statusEl = document.getElementById('status-db');
            try {
                // Forzamos "accion=listar_asistencia" que ya existe en tu script recuperado
                const response = await fetch(`${APPS_SCRIPT_URL}?accion=listar_asistencia`);
                const data = await response.json();
                
                if (data.result === "success") {
                    listaInvitados = data.message;
                    statusEl.innerText = `‚úÖ Lista cargada: ${listaInvitados.length} parejas.`;
                    statusEl.classList.remove('animate-pulse', 'text-gray-400');
                    statusEl.classList.add('text-green-400', 'font-bold');
                    iniciarScanner(); // Iniciamos c√°mara solo cuando hay datos
                } else {
                    throw new Error(data.message);
                }
            } catch (e) {
                statusEl.innerText = "‚ùå Error cargando lista. Recarga la p√°gina.";
                statusEl.classList.remove('text-gray-400');
                statusEl.classList.add('text-red-500');
                alert("Error de conexi√≥n con Google Sheets: " + e.message);
            }
        }

        // --- 2. EL CEREBRO: NORMALIZADOR DE TEXTO ---
        // Esto soluciona el "Pase no encontrado"
        function normalizar(texto) {
            if (!texto) return "";
            return texto.toString()
                .toLowerCase() // Todo a min√∫sculas
                .replace("registro:", "") // Quitamos la palabra clave del QR
                .trim() // Quitamos espacios al inicio y final
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Quitamos tildes (√° -> a)
                .replace(/\s+/g, " "); // Quitamos espacios dobles
        }

        // --- 3. L√ìGICA DE ESCANEO ---
        function onScanSuccess(decodedText, decodedResult) {
            if (!isScanning) return; // Evitar disparos m√∫ltiples
            
            // Pausamos visualmente
            isScanning = false; 
            if(html5QrcodeScanner) html5QrcodeScanner.pause();

            console.log("QR Crudo:", decodedText);
            const qrLimpio = normalizar(decodedText);
            console.log("QR Limpio:", qrLimpio);

            // B√∫squeda Inteligente
            const encontrado = listaInvitados.find(invitado => {
                const dbNombre = normalizar(invitado.nombres);
                // Verificamos si el QR contiene el nombre de la BD o viceversa
                return dbNombre.includes(qrLimpio) || qrLimpio.includes(dbNombre);
            });

            if (encontrado) {
                if (encontrado.asistio) {
                    mostrarPantalla("warning", "‚ö†Ô∏è YA INGRES√ì", encontrado.nombres, "Esta pareja ya fue marcada anteriormente.");
                } else {
                    mostrarPantalla("success", "‚úÖ BIENVENIDOS", encontrado.nombres, "Registro Exitoso. ¬°Disfruten la noche!");
                    registrarEntradaBackend(encontrado.fila);
                    encontrado.asistio = true; // Actualizamos memoria local para no dejar pasar doble
                }
            } else {
                mostrarPantalla("error", "‚ùå NO ENCONTRADO", "QR Inv√°lido", "Verifique que sea el pase correcto de este evento.");
            }
        }

        function onScanFailure(error) {
            // No hacemos nada, es ruido normal mientras busca QRs
        }

        // --- 4. INTERFAZ GR√ÅFICA (OVERLAY) ---
        function mostrarPantalla(tipo, titulo, nombre, mensaje) {
            const overlay = document.getElementById('result-overlay');
            const icon = document.getElementById('result-icon');
            
            // Reseteamos clases de color
            overlay.classList.remove('success-screen', 'error-screen', 'warning-screen', 'hidden');
            
            if (tipo === 'success') {
                overlay.classList.add('success-screen');
                icon.innerText = "‚ú®";
            } else if (tipo === 'error') {
                overlay.classList.add('error-screen');
                icon.innerText = "üö´";
            } else { // warning
                overlay.classList.add('warning-screen');
                icon.innerText = "‚úã";
            }

            document.getElementById('result-title').innerText = titulo;
            document.getElementById('result-name').innerText = nombre;
            document.getElementById('result-msg').innerText = mensaje;
        }

        function cerrarOverlay() {
            document.getElementById('result-overlay').classList.add('hidden');
            isScanning = true;
            if(html5QrcodeScanner) html5QrcodeScanner.resume();
        }

        // --- 5. GUARDAR EN GOOGLE SHEETS ---
        async function registrarEntradaBackend(fila) {
            try {
                // Llamamos a la funci√≥n marcar_asistencia de tu script
                await fetch(`${APPS_SCRIPT_URL}?accion=marcar_asistencia&fila=${fila}`, {method: 'POST'});
                console.log("Asistencia guardada en nube.");
            } catch (e) {
                console.error("Error guardando en nube (pero ya entr√≥ localmente)", e);
            }
        }

        // --- 6. INICIAR LIBRER√çA ---
        function iniciarScanner() {
            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader", 
                { 
                    fps: 10, 
                    qrbox: {width: 250, height: 250},
                    aspectRatio: 1.0
                },
                /* verbose= */ false);
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        }

        // Cargar al inicio
        window.onload = cargarBaseDatos;

    </script>
</body>
</html>
