<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Entrada PRO</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .loader { border-top-color: #ec4899; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #reader { width: 100%; min-height: 300px; background: #000; border-radius: 10px; overflow: hidden; }
        .hidden-input { display: none; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <script>
        // =================================================================
        // üëáüëáüëá ¬°PEGA AQU√ç TU NUEVA URL DEL BACKEND V700! üëáüëáüëá
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzKQCHQuXvaHldPXksVJ_XJ9UvV_eRRLwQZ94apTTNtMPZL3d0fFFAIIWhKg6CC2REzlA/exec";
        // =================================================================
    </script>

    <div class="max-w-md mx-auto p-4 flex flex-col h-screen">
        
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-xl font-bold text-pink-500 flex items-center gap-2">
                <i class="fas fa-heart"></i> Entrada
            </h1>
            <button onclick="toggleModo()" id="btnModo" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition">
                <i class="fas fa-list"></i> Contingencia
            </button>
        </div>

        <div id="modoScanner" class="flex-grow flex flex-col items-center">
            <div id="reader" class="shadow-lg border-2 border-pink-500 mb-4 relative"></div>
            <p class="text-gray-400 text-sm text-center mb-2">Apunta al c√≥digo QR de la pareja</p>
            <div id="scanResult" class="w-full"></div>
            <button onclick="iniciarScanner()" class="mt-4 text-xs text-gray-500 underline">Reiniciar C√°mara</button>
        </div>

        <div id="modoContingencia" class="hidden flex-grow flex flex-col">
            <div class="mb-4">
                <input type="text" id="searchInput" onkeyup="filtrarLista()" placeholder="Buscar por nombre..." 
                       class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:border-pink-500 placeholder-gray-500">
            </div>
            <div class="flex-grow overflow-y-auto bg-gray-800 rounded-lg p-2 border border-gray-700" id="listaParejas">
                <p class="text-center text-gray-500 mt-10">Cargando lista...</p>
            </div>
        </div>

        <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden-input" onchange="procesarFoto()">

        <div id="loader" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-90 flex flex-col justify-center items-center z-50 hidden">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-16 w-16 mb-4"></div>
            <h2 id="loaderText" class="text-xl font-semibold text-white">Procesando...</h2>
        </div>
    </div>

    <audio id="audioSuccess" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="audioError" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3"></audio>

    <script>
        let html5QrCode;
        let listaGlobal = [];
        let filaSeleccionada = null;
        let modoActual = "SCANNER";

        window.onload = function() {
            cargarDatos(); 
            iniciarScanner(); 
        };

        function iniciarScanner() {
            if(html5QrCode) {
                html5QrCode.stop().then(() => { html5QrCode.clear(); lanzarCamara(); })
                .catch(() => { lanzarCamara(); });
            } else {
                lanzarCamara();
            }
        }

        function lanzarCamara() {
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess).catch(console.error);
        }

        function onScanSuccess(decodedText) {
            html5QrCode.pause(); 
            procesarEntradaQR(decodedText);
        }

        function toggleModo() {
            const scanDiv = document.getElementById("modoScanner");
            const contDiv = document.getElementById("modoContingencia");
            const btn = document.getElementById("btnModo");

            if (modoActual === "SCANNER") {
                modoActual = "CONTINGENCIA";
                scanDiv.classList.add("hidden");
                contDiv.classList.remove("hidden");
                btn.innerHTML = '<i class="fas fa-qrcode"></i> Scanner';
                btn.classList.replace("bg-blue-600", "bg-pink-600");
                try { html5QrCode.stop(); } catch(e){}
            } else {
                modoActual = "SCANNER";
                scanDiv.classList.remove("hidden");
                contDiv.classList.add("hidden");
                btn.innerHTML = '<i class="fas fa-list"></i> Contingencia';
                btn.classList.replace("bg-pink-600", "bg-blue-600");
                iniciarScanner();
            }
        }

        async function cargarDatos() {
            if(SCRIPT_URL.includes("PEGAR_AQUI")) { alert("‚ö†Ô∏è Pega la nueva URL"); return; }
            try {
                // Usamos 'listar_envios' que es compatible con V700
                const response = await fetch(`${SCRIPT_URL}?accion=listar_envios&nocache=${Date.now()}`);
                const data = await response.json();
                if(data.result === "success") {
                    listaGlobal = data.message;
                    renderizarLista(listaGlobal);
                }
            } catch(e) { console.error("Error lista", e); }
        }

        function renderizarLista(lista) {
            const contenedor = document.getElementById("listaParejas");
            contenedor.innerHTML = "";
            if(lista.length === 0) { contenedor.innerHTML = '<p class="text-center text-gray-500 mt-5">Vac√≠o</p>'; return; }

            lista.forEach(item => {
                const div = document.createElement("div");
                div.className = "flex justify-between items-center p-3 border-b border-gray-700 hover:bg-gray-700 transition";
                let btnHtml = item.asistio ? 
                    `<span class="text-green-400 font-bold text-xs bg-green-900 bg-opacity-30 px-2 py-1 rounded">‚úÖ Adentro</span>` :
                    `<button onclick="iniciarCamara(${item.fila})" class="bg-blue-600 text-white px-3 py-2 rounded text-xs font-bold shadow">üì∏ Foto</button>`;

                div.innerHTML = `<div class="text-sm"><p class="font-bold text-white">${item.esposo}</p><p class="text-gray-400 text-xs">& ${item.esposa}</p></div><div>${btnHtml}</div>`;
                contenedor.appendChild(div);
            });
        }

        function filtrarLista() {
            const texto = document.getElementById("searchInput").value.toLowerCase();
            const filtrados = listaGlobal.filter(item => 
                (item.esposo && item.esposo.toLowerCase().includes(texto)) ||
                (item.esposa && item.esposa.toLowerCase().includes(texto))
            );
            renderizarLista(filtrados);
        }

        function iniciarCamara(fila) {
            filaSeleccionada = fila;
            document.getElementById("cameraInput").click();
        }

        function procesarFoto() {
            const input = document.getElementById("cameraInput");
            if (input.files && input.files[0]) {
                // Aqu√≠ solo simulamos subida para marcar asistencia, ya que Drive requiere permisos complejos
                // El backend V700 marcar√° el Check-in al recibir 'registrar_contingencia'
                mostrarLoader(true, "Registrando...");
                enviarFotoAlServidor(filaSeleccionada, "dummy_base64");
            }
        }

        async function enviarFotoAlServidor(fila, base64) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ accion: 'registrar_contingencia', fila: fila })
                });
                const data = await response.json();
                if (data.result === "success") {
                    document.getElementById("audioSuccess").play();
                    alert("‚úÖ Registrado por contingencia.");
                    cargarDatos();
                } else { alert("Error: " + data.message); }
            } catch(e) { alert("Error red: " + e); } 
            finally { mostrarLoader(false); document.getElementById("cameraInput").value = ""; }
        }

        function normalizar(t) { return t ? t.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() : ""; }

        async function procesarEntradaQR(textoQR) {
            mostrarLoader(true, "Verificando...");
            const textoLimpio = normalizar(textoQR).replace("registro:", "").trim();
            const partes = textoLimpio.split("&").map(s => s.trim());
            
            const encontrado = listaGlobal.find(item => {
                const e1 = normalizar(item.esposo);
                const e2 = normalizar(item.esposa);
                return (partes[0] && e1.includes(partes[0])) || (partes[1] && e2.includes(partes[1]));
            });

            if (encontrado) {
                if (encontrado.asistio) {
                    mostrarResultado("‚ö†Ô∏è YA INGRES√ì", "bg-yellow-500");
                    document.getElementById("audioError").play();
                } else {
                    // Usamos fetch con params en URL que el Backend V700 ahora entiende
                    await fetch(`${SCRIPT_URL}?accion=marcar_asistencia&fila=${encontrado.fila}`, {method:'POST'});
                    mostrarResultado("‚úÖ ADELANTE: " + encontrado.esposo, "bg-green-600");
                    document.getElementById("audioSuccess").play();
                    encontrado.asistio = true;
                    cargarDatos();
                }
            } else {
                mostrarResultado("‚ùå NO ENCONTRADO", "bg-red-600");
                document.getElementById("audioError").play();
            }
            mostrarLoader(false);
            setTimeout(() => { document.getElementById("scanResult").innerHTML = ""; html5QrCode.resume(); }, 3000);
        }

        function mostrarResultado(t, c) {
            document.getElementById("scanResult").innerHTML = `<div class="${c} text-white p-6 rounded-lg text-center shadow-lg border-2 border-white animate-bounce"><p class="text-2xl font-bold">${t}</p></div>`;
        }

        function mostrarLoader(show, text="Cargando...") {
            document.getElementById("loader").classList.toggle("hidden", !show);
            document.getElementById("loaderText").innerText = text;
        }
    </script>
</body>
</html>
