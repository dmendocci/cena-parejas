<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Entrada - Cena Parejas</title>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        body { background-color: #1a202c; color: white; font-family: sans-serif; }
        /* El contenedor del lector */
        #reader { width: 100%; border-radius: 10px; overflow: hidden; background: #000; margin-bottom: 20px; border: 2px solid #4a5568; }
        
        /* Colores de estado */
        .success-screen { background-color: #22c55e; } /* Verde */
        .error-screen { background-color: #ef4444; }   /* Rojo */
        .warning-screen { background-color: #f59e0b; } /* Amarillo */
        
        /* Botones de la librer√≠a m√°s bonitos */
        #html5-qrcode-button-camera-stop, #html5-qrcode-button-camera-start, #html5-qrcode-button-camera-permission {
            padding: 8px 16px; border-radius: 5px; background: #3b82f6; color: white; border: none; margin: 5px; cursor: pointer;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div class="p-4 bg-gray-900 shadow-md z-10 text-center border-b border-gray-800">
        <h1 class="text-xl font-bold text-red-500 tracking-wider">SCANNER ENTRADA ‚ù§Ô∏è</h1>
        <p id="status-db" class="text-xs text-gray-400 mt-1 animate-pulse">Conectando con base de datos...</p>
    </div>

    <div class="flex-grow flex flex-col items-center justify-start pt-6 px-4 overflow-y-auto">
        
        <div id="reader"></div>
        
        <div class="text-sm text-gray-400 text-center mt-2 px-4 bg-gray-800 p-2 rounded">
            üí° <b>Tip:</b> Si la c√°mara no enfoca, selecciona otra opci√≥n en el men√∫ "Select Camera" que aparece arriba del video.
        </div>
    </div>

    <div id="result-overlay" class="fixed inset-0 hidden flex flex-col items-center justify-center text-center p-6 z-50 transition-all duration-300">
        <div id="result-icon" class="text-8xl mb-4 transform hover:scale-110 transition-transform"></div>
        <h2 id="result-title" class="text-4xl font-bold mb-2 uppercase drop-shadow-md"></h2>
        <p id="result-name" class="text-2xl font-semibold drop-shadow-sm text-white border-b-2 border-white/20 pb-2 mb-2"></p>
        <p id="result-msg" class="mt-2 text-lg opacity-90 text-white font-medium"></p>
        
        <button onclick="cerrarOverlay()" class="mt-8 bg-white text-gray-900 font-bold py-4 px-12 rounded-full shadow-2xl text-lg hover:bg-gray-100 active:scale-95 transition-all">
            ESCANEAR SIGUIENTE
        </button>
    </div>

    <script>
        // ==========================================
        // ‚ö†Ô∏è PEGA AQU√ç LA URL DE TU SCRIPT (VERSI√ìN 2)
        // ==========================================
        const APPS_SCRIPT_URL = 'AQUI_PEGA_TU_URL_DEL_SCRIPT_QUE_TERMINA_EN_EXEC'; 
        // ==========================================

        let listaInvitados = [];
        let html5QrcodeScanner = null;
        let isScanning = true;

        // --- 1. CARGA DE BASE DE DATOS (AL ABRIR LA P√ÅGINA) ---
        async function cargarBaseDatos() {
            const statusEl = document.getElementById('status-db');
            try {
                // Usamos "listar_asistencia" que ya confirmamos que est√° en tu script
                const response = await fetch(`${APPS_SCRIPT_URL}?accion=listar_asistencia`);
                const data = await response.json();
                
                if (data.result === "success") {
                    listaInvitados = data.message;
                    statusEl.innerHTML = `‚úÖ <b>LISTO:</b> ${listaInvitados.length} parejas cargadas.`;
                    statusEl.classList.remove('animate-pulse', 'text-gray-400');
                    statusEl.classList.add('text-green-400');
                    
                    // Iniciamos la c√°mara SOLO cuando tenemos los datos
                    iniciarScanner(); 
                } else {
                    throw new Error(data.message);
                }
            } catch (e) {
                statusEl.innerHTML = "‚ùå <b>ERROR:</b> No se pudo cargar la lista.";
                statusEl.classList.remove('text-gray-400');
                statusEl.classList.add('text-red-500');
                alert("Error conectando con Google Sheets. Verifica internet y recarga.");
                console.error(e);
            }
        }

        // --- 2. EL SOLUCIONADOR DE TEXTO (NORMALIZAR) ---
        // Hace que "Carlos" sea igual a "CARLOS" o "carlos "
        function normalizar(texto) {
            if (!texto) return "";
            return texto.toString()
                .toLowerCase()                    // Min√∫sculas
                .replace("registro:", "")         // Quitar prefijo
                .trim()                           // Quitar espacios extra
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Quitar tildes
                .replace(/\s+/g, " ");            // Espacios dobles a simples
        }

        // --- 3. CUANDO SE ESCANEA UN QR ---
        function onScanSuccess(decodedText, decodedResult) {
            if (!isScanning) return; 
            
            // 1. Pausar escaneo
            isScanning = false; 
            if(html5QrcodeScanner) html5QrcodeScanner.pause();

            const qrLimpio = normalizar(decodedText);
            console.log("Le√≠do:", qrLimpio);

            // 2. Buscar en la lista (B√∫squeda flexible)
            const encontrado = listaInvitados.find(invitado => {
                const dbNombre = normalizar(invitado.nombres);
                // ¬øEl nombre de la BD est√° en el QR? O ¬øEl QR est√° en el nombre de la BD?
                return dbNombre.includes(qrLimpio) || qrLimpio.includes(dbNombre);
            });

            // 3. Mostrar resultado
            if (encontrado) {
                if (encontrado.asistio) {
                    mostrarPantalla("warning", "‚ö†Ô∏è YA INGRES√ì", encontrado.nombres, "Esta pareja ya fue marcada antes.");
                } else {
                    mostrarPantalla("success", "‚úÖ BIENVENIDOS", encontrado.nombres, "Pase v√°lido. ¬°Adelante!");
                    // 4. Guardar en la nube (sin esperar)
                    registrarEntradaBackend(encontrado.fila);
                    // 5. Marcar localmente para no dejar pasar doble si falla internet
                    encontrado.asistio = true; 
                }
            } else {
                mostrarPantalla("error", "‚ùå NO ENCONTRADO", "Pase Desconocido", "Verifique que sea de este evento.");
            }
        }

        function onScanFailure(error) {
            // Ignorar errores de lectura en vac√≠o
        }

        // --- 4. CONTROL DE PANTALLAS (VERDE/ROJO) ---
        function mostrarPantalla(tipo, titulo, nombre, mensaje) {
            const overlay = document.getElementById('result-overlay');
            const icon = document.getElementById('result-icon');
            
            overlay.className = "fixed inset-0 flex flex-col items-center justify-center text-center p-6 z-50 transition-all duration-300 text-white";
            
            if (tipo === 'success') {
                overlay.classList.add('success-screen');
                icon.innerText = "‚ú®";
                // Sonido opcional si quieres
                // new Audio('https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg').play().catch(e=>{});
            } else if (tipo === 'error') {
                overlay.classList.add('error-screen');
                icon.innerText = "üö´";
            } else {
                overlay.classList.add('warning-screen');
                icon.innerText = "‚úã";
            }

            document.getElementById('result-title').innerText = titulo;
            document.getElementById('result-name').innerText = nombre;
            document.getElementById('result-msg').innerText = mensaje;
            
            overlay.classList.remove('hidden');
        }

        function cerrarOverlay() {
            document.getElementById('result-overlay').classList.add('hidden');
            isScanning = true;
            if(html5QrcodeScanner) html5QrcodeScanner.resume();
        }

        // --- 5. ENVIAR DATOS A GOOGLE SHEETS ---
        async function registrarEntradaBackend(fila) {
            try {
                await fetch(`${APPS_SCRIPT_URL}?accion=marcar_asistencia&fila=${fila}`, {method: 'POST'});
            } catch (e) {
                console.error("Fallo al guardar en nube, pero el pase es v√°lido localmente.");
            }
        }

        // --- 6. INICIAR LIBRER√çA DE C√ÅMARA ---
        function iniciarScanner() {
            // Configuraci√≥n optimizada para m√≥viles
            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader", 
                { 
                    fps: 10, 
                    qrbox: {width: 250, height: 250},
                    aspectRatio: 1.0,
                    showTorchButtonIfSupported: true // Bot√≥n de linterna si el cel lo soporta
                },
                false);
            
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        }

        // Arrancar todo al cargar la p√°gina
        window.onload = cargarBaseDatos;

    </script>
</body>
</html>
