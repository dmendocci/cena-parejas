<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Entrada</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; }
        .hidden-input { display: none; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <script>
        // === PEGA AQUÍ LA NUEVA URL DEL SCRIPT V50 ===
        const SCRIPT_URL = "PEGAR_NUEVA_URL_AQUI";
    </script>

    <div class="max-w-md mx-auto p-4 flex flex-col h-screen">
        
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold text-pink-500"><i class="fas fa-qrcode"></i> Entrada</h1>
            <button onclick="toggleModo()" id="btnModo" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition">
                <i class="fas fa-list"></i> Contingencia
            </button>
        </div>

        <div id="modoScanner" class="flex-grow flex flex-col items-center justify-center">
            <div id="reader" class="bg-black shadow-lg border-2 border-pink-500"></div>
            <p class="mt-4 text-gray-400 text-sm text-center">Escanea el código QR de la pareja</p>
            <div id="scanResult" class="mt-4 w-full"></div>
        </div>

        <div id="modoContingencia" class="hidden flex-grow flex flex-col">
            <div class="mb-4">
                <input type="text" id="searchInput" onkeyup="filtrarLista()" placeholder="Buscar por nombre..." 
                       class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:border-pink-500">
            </div>
            
            <div class="flex-grow overflow-y-auto bg-gray-800 rounded-lg p-2" id="listaParejas">
                <p class="text-center text-gray-500 mt-10">Cargando datos...</p>
            </div>
        </div>

        <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden-input" onchange="procesarFoto()">

        <div id="loader" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-90 flex flex-col justify-center items-center z-50 hidden">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-16 w-16 mb-4"></div>
            <h2 id="loaderText" class="text-xl font-semibold text-white">Procesando...</h2>
        </div>

    </div>

    <audio id="audioSuccess" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="audioError" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3"></audio>

    <script>
        let html5QrcodeScanner;
        let listaGlobal = [];
        let filaSeleccionada = null; // Para saber a quién le estamos tomando la foto
        let modoActual = "SCANNER";

        // --- INICIALIZACIÓN ---
        function onScanSuccess(decodedText, decodedResult) {
            html5QrcodeScanner.pause();
            procesarEntradaQR(decodedText);
        }

        // Iniciar Scanner
        html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        html5QrcodeScanner.render(onScanSuccess);
        
        // Cargar datos en segundo plano
        cargarDatos();

        // --- LÓGICA DE MODOS ---
        function toggleModo() {
            const scanDiv = document.getElementById("modoScanner");
            const contDiv = document.getElementById("modoContingencia");
            const btn = document.getElementById("btnModo");

            if (modoActual === "SCANNER") {
                // Cambiar a Contingencia
                modoActual = "CONTINGENCIA";
                scanDiv.classList.add("hidden");
                contDiv.classList.remove("hidden");
                btn.innerHTML = '<i class="fas fa-qrcode"></i> Scanner';
                btn.classList.replace("bg-blue-600", "bg-pink-600");
                try { html5QrcodeScanner.pause(); } catch(e){}
            } else {
                // Cambiar a Scanner
                modoActual = "SCANNER";
                scanDiv.classList.remove("hidden");
                contDiv.classList.add("hidden");
                btn.innerHTML = '<i class="fas fa-list"></i> Contingencia';
                btn.classList.replace("bg-pink-600", "bg-blue-600");
                try { html5QrcodeScanner.resume(); } catch(e){}
            }
        }

        // --- CARGAR Y LISTAR DATOS ---
        async function cargarDatos() {
            try {
                const response = await fetch(`${SCRIPT_URL}?accion=listar_asistencia`);
                const data = await response.json();
                if(data.result === "success") {
                    listaGlobal = data.message;
                    renderizarLista(listaGlobal);
                }
            } catch(e) { console.error("Error cargando lista"); }
        }

        function renderizarLista(lista) {
            const contenedor = document.getElementById("listaParejas");
            contenedor.innerHTML = "";
            
            if(lista.length === 0) {
                contenedor.innerHTML = '<p class="text-center text-gray-500 mt-5">No hay coincidencias.</p>';
                return;
            }

            lista.forEach(item => {
                const div = document.createElement("div");
                div.className = "flex justify-between items-center p-3 border-b border-gray-700 hover:bg-gray-700 transition";
                
                let btnHtml = "";
                if(item.asistio) {
                    btnHtml = `<span class="text-green-400 font-bold text-xs"><i class="fas fa-check-circle"></i> Adentro</span>`;
                } else {
                    btnHtml = `<button onclick="iniciarCamara(${item.fila})" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded text-xs font-bold shadow">
                                <i class="fas fa-camera"></i> Registrar
                               </button>`;
                }

                div.innerHTML = `
                    <div class="text-sm">
                        <p class="font-bold text-white">${item.esposo}</p>
                        <p class="text-gray-400 text-xs">& ${item.esposa}</p>
                    </div>
                    <div>${btnHtml}</div>
                `;
                contenedor.appendChild(div);
            });
        }

        function filtrarLista() {
            const texto = document.getElementById("searchInput").value.toLowerCase();
            const filtrados = listaGlobal.filter(item => 
                (item.esposo && item.esposo.toLowerCase().includes(texto)) ||
                (item.esposa && item.esposa.toLowerCase().includes(texto))
            );
            renderizarLista(filtrados);
        }

        // --- LÓGICA DE CÁMARA Y FOTO ---
        function iniciarCamara(fila) {
            filaSeleccionada = fila;
            document.getElementById("cameraInput").click(); // Abre la cámara nativa
        }

        function procesarFoto() {
            const input = document.getElementById("cameraInput");
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                mostrarLoader(true, "Subiendo foto...");
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Img = e.target.result.split(',')[1]; // Quitar cabecera "data:image..."
                    enviarFotoAlServidor(filaSeleccionada, base64Img);
                };
                reader.readAsDataURL(file);
            }
        }

        async function enviarFotoAlServidor(fila, base64) {
            try {
                // Usamos POST porque la imagen es grande
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        accion: 'registrar_contingencia',
                        fila: fila,
                        imagen: base64
                    })
                });
                
                const data = await response.json();
                
                if (data.result === "success") {
                    document.getElementById("audioSuccess").play();
                    alert("✅ Entrada registrada con foto.");
                    cargarDatos(); // Recargar lista para ver el "Adentro"
                } else {
                    alert("❌ Error: " + data.message);
                }
            } catch(e) {
                alert("❌ Error de conexión al subir foto.");
            } finally {
                mostrarLoader(false);
                document.getElementById("cameraInput").value = ""; // Limpiar input
            }
        }

        // --- LÓGICA QR (LEGACY) ---
        function normalizar(texto) {
            if(!texto) return "";
            return texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
        }

        async function procesarEntradaQR(textoQR) {
            mostrarLoader(true, "Verificando...");
            const textoLimpio = normalizar(textoQR).replace("registro:", "").trim();
            const partes = textoLimpio.split("&").map(s => s.trim());
            
            // Buscar en la lista local (que ya descargamos)
            const encontrado = listaGlobal.find(item => {
                const dbEsposo = normalizar(item.esposo);
                const dbEsposa = normalizar(item.esposa);
                return (partes[0] && dbEsposo.includes(partes[0])) || (partes[1] && dbEsposa.includes(partes[1]));
            });

            if (encontrado) {
                if (encontrado.asistio) {
                    mostrarResultado("⚠️ YA REGISTRADO", "bg-yellow-500");
                    document.getElementById("audioError").play();
                } else {
                    // Registrar check-in simple
                    await fetch(`${SCRIPT_URL}?accion=marcar_asistencia&fila=${encontrado.fila}`, {method:'POST'});
                    mostrarResultado("✅ BIENVENIDOS: " + encontrado.esposo, "bg-green-600");
                    document.getElementById("audioSuccess").play();
                    encontrado.asistio = true; // Actualizar local
                    cargarDatos(); // Refrescar lista de fondo
                }
            } else {
                mostrarResultado("❌ NO ENCONTRADO", "bg-red-600");
                document.getElementById("audioError").play();
            }
            mostrarLoader(false);
            setTimeout(() => { 
                document.getElementById("scanResult").innerHTML = ""; 
                html5QrcodeScanner.resume();
            }, 3000);
        }

        function mostrarResultado(texto, colorClass) {
            const div = document.getElementById("scanResult");
            div.innerHTML = `<div class="${colorClass} text-white p-4 rounded text-center font-bold text-lg shadow-lg animate-pulse">${texto}</div>`;
        }

        function mostrarLoader(show, text="Cargando...") {
            document.getElementById("loader").classList.toggle("hidden", !show);
            document.getElementById("loaderText").innerText = text;
        }

    </script>
</body>
</html>
