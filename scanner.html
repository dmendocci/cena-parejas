<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCANNER DE ACCESO</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #000; color: white; } 
        #reader { width: 100%; border-radius: 10px; overflow: hidden; border: 2px solid #444; }
        .resultado-box { animation: popIn 0.3s ease-out; }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 justify-center">

    <script>
        // =================================================================
        // üëá URL BACKEND V600 (N√∫cleo H√≠brido) üëá
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwGfLY0KVB6GNtBzCO093lrR2jm4B2ZpfemjgkDGz1EBJpEazAvsNvtqNgoLz4zo9xFrw/exec"; 
        // =================================================================
    </script>

    <div class="w-full max-w-md mb-6 text-center">
        <h1 class="text-3xl font-bold text-white mb-2">üì∑ Scanner de Entrada</h1>
        <p class="text-gray-400 text-sm">Apunte la c√°mara al c√≥digo QR</p>
    </div>

    <div class="w-full max-w-md relative mb-4">
        <div id="reader"></div>
        <div id="loadingOverlay" class="absolute inset-0 bg-black bg-opacity-90 flex flex-col items-center justify-center z-10">
            <i class="fas fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
            <p class="text-lg font-bold">Sincronizando lista...</p>
        </div>
    </div>

    <div id="resultArea" class="w-full max-w-md hidden"></div>

    <button onclick="reiniciarScanner()" id="btnReset" class="hidden mt-8 bg-blue-600 text-white px-8 py-4 rounded-full font-bold shadow-lg hover:bg-blue-700 transition text-lg w-full max-w-xs">
        <i class="fas fa-qrcode"></i> Escanear Siguiente
    </button>

    <audio id="audioOk" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="audioFail" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3"></audio>

    <script>
        let html5QrCode;
        let listaGlobal = [];
        let isScanning = true;

        // 1. CARGA INICIAL DE DATOS
        window.onload = async function() {
            try {
                // üî• FIX CR√çTICO: Usamos 'listar_envios' + Anti-Cach√©
                const cacheBuster = `&nocache=${new Date().getTime()}`;
                console.log("Descargando base de datos actualizada...");
                
                const response = await fetch(`${SCRIPT_URL}?accion=listar_envios${cacheBuster}`);
                const data = await response.json();
                
                if(data.result === "success") {
                    listaGlobal = data.message;
                    console.log(`Base de datos cargada: ${listaGlobal.length} registros.`);
                    document.getElementById("loadingOverlay").classList.add("hidden");
                    iniciarCamara();
                } else {
                    alert("‚ö†Ô∏è Error del servidor: " + data.message);
                }
            } catch(e) {
                console.error(e);
                alert("‚ùå Error de conexi√≥n. Verifique su internet.");
            }
        };

        function iniciarCamara() {
            html5QrCode = new Html5Qrcode("reader");
            // Configuraci√≥n optimizada para lectura r√°pida
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                console.error(err);
                alert("Error: No se pudo acceder a la c√°mara. Verifique permisos.");
            });
        }

        function onScanSuccess(decodedText) {
            if (!isScanning) return;
            
            // 1. Pausar para evitar lecturas m√∫ltiples
            html5QrCode.pause();
            isScanning = false;
            
            // 2. Verificar datos
            verificarQR(decodedText);
        }

        function verificarQR(textoQR) {
            const area = document.getElementById("resultArea");
            const btn = document.getElementById("btnReset");
            area.classList.remove("hidden");
            btn.classList.remove("hidden");

            // Normalizaci√≥n de texto (quitar acentos, min√∫sculas)
            const normalizar = (t) => t ? t.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() : "";
            
            let textoLimpio = decodeURIComponent(textoQR);
            let textoNorm = normalizar(textoLimpio);

            // B√∫squeda en memoria
            const encontrado = listaGlobal.find(item => {
                const esposo = normalizar(item.esposo);
                const esposa = normalizar(item.esposa);
                // Coincidencia parcial o total
                return (esposo && textoNorm.includes(esposo)) || (esposa && textoNorm.includes(esposa));
            });

            if (encontrado) {
                // ‚úÖ √âXITO: ENCONTRADO
                document.getElementById("audioOk").play();
                
                // Determinar estado de color
                let colorClass = encontrado.asistio ? "bg-yellow-600" : "bg-green-600";
                let icono = encontrado.asistio ? "fa-exclamation-triangle" : "fa-check-circle";
                let titulo = encontrado.asistio ? "YA INGRES√ì" : "ACCESO PERMITIDO";
                let mensajeEstado = encontrado.asistio ? "Esta pareja ya fue marcada anteriormente." : "Bienvenido(a)";

                area.innerHTML = `
                    <div class="resultado-box ${colorClass} text-white p-6 rounded-xl shadow-2xl text-center border-4 border-white mt-4">
                        <div class="text-6xl mb-4"><i class="fas ${icono}"></i></div>
                        <h2 class="text-3xl font-bold mb-2 uppercase">${titulo}</h2>
                        
                        <div class="bg-black bg-opacity-30 p-4 rounded-lg mt-4">
                            <p class="text-xs uppercase tracking-wider opacity-75 mb-1">Pareja Registrada:</p>
                            <p class="text-2xl font-bold">${encontrado.esposo}</p>
                            <p class="text-lg">& ${encontrado.esposa}</p>
                        </div>

                        <div class="flex justify-center gap-2 mt-4">
                            <span class="text-xs bg-white text-black px-3 py-1 rounded-full font-bold">
                                Fila #${encontrado.fila}
                            </span>
                            <span class="text-xs bg-white text-black px-3 py-1 rounded-full font-bold">
                                ${encontrado.tienePago ? "üí∞ PAGO OK" : "‚ö†Ô∏è PAGO PENDIENTE"}
                            </span>
                        </div>
                        
                        <p class="mt-4 text-sm font-medium opacity-90">${mensajeEstado}</p>
                    </div>
                `;
                
                // Aqu√≠ podr√≠as agregar una llamada fetch para marcar asistencia autom√°ticamente si quisieras
                // marcarAsistencia(encontrado.fila); 

            } else {
                // ‚ùå ERROR: NO ENCONTRADO
                document.getElementById("audioFail").play();
                area.innerHTML = `
                    <div class="resultado-box bg-red-600 text-white p-6 rounded-xl shadow-2xl text-center border-4 border-white mt-4">
                        <div class="text-6xl mb-4"><i class="fas fa-times-circle"></i></div>
                        <h2 class="text-3xl font-bold mb-2">ACCESO DENEGADO</h2>
                        <p class="text-lg mb-4">C√≥digo QR no v√°lido o no existe en lista.</p>
                        <div class="bg-black bg-opacity-30 p-2 rounded text-xs font-mono break-all">
                            Datos: ${textoQR}
                        </div>
                    </div>
                `;
            }
        }

        function reiniciarScanner() {
            document.getElementById("resultArea").classList.add("hidden");
            document.getElementById("btnReset").classList.add("hidden");
            document.getElementById("resultArea").innerHTML = ""; // Limpiar anterior
            isScanning = true;
            html5QrCode.resume();
        }

    </script>
</body>
</html>
