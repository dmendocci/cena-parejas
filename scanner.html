<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Entrada</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        body { background-color: #000; color: white; font-family: sans-serif; }
        #reader { width: 100%; border-radius: 0 0 20px 20px; overflow: hidden; border-bottom: 2px solid #333; }
        .success { background-color: #22c55e; } 
        .error { background-color: #ef4444; }   
        .warning { background-color: #f59e0b; } 
        button { padding: 15px 30px; border-radius: 50px; font-weight: bold; margin-top: 20px; font-size: 18px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div id="reader" class="flex-grow bg-black"></div>

    <div class="p-4 text-center bg-gray-900">
        <p id="status-db" class="text-sm text-gray-400 animate-pulse">‚è≥ Conectando con base de datos...</p>
        <p class="text-xs text-gray-600 mt-1">Modo: Solo con QR V√°lido</p>
    </div>

    <div id="overlay" class="fixed inset-0 hidden flex flex-col items-center justify-center p-6 text-center z-50 text-white">
        <div id="icon" class="text-8xl mb-6"></div>
        <h2 id="title" class="text-4xl font-bold mb-2 uppercase tracking-wide"></h2>
        <p id="name" class="text-2xl font-semibold mb-2 border-b border-white/30 pb-2"></p>
        <p id="msg" class="text-lg opacity-90"></p>
        <button onclick="resetScanner()" class="bg-white text-gray-900 hover:bg-gray-200 transition-colors">SIGUIENTE PAREJA</button>
    </div>

    <script>
        // ==========================================
        // ‚ö†Ô∏è PEGA AQU√ç LA URL DE TU SCRIPT
        // ==========================================
        const URL_SCRIPT = 'https://script.google.com/macros/s/AKfycbyBLSQ9UTUL9cD7CtwAb9ZqecvDKK2DN3XgJbZ4IMtADoucQpYG1Cm7xnuFIC28EzhI8Q/exec'; 
        // ==========================================

        let invitados = [];
        let scanner = null;
        let escaneando = true;

        async function iniciarSistema() {
            const status = document.getElementById('status-db');
            try {
                // Pedimos los datos al script viejo
                const resp = await fetch(`${URL_SCRIPT}?accion=listar_todo`);
                const json = await resp.json();
                
                if (json.result === "success") {
                    const listaCruda = json.message;
                    
                    // === AQU√ç EST√Å EL FILTRO QUE PIDES ===
                    invitados = listaCruda.filter(item => {
                        // CONDICI√ìN 1: Que tenga un LINK (QR generado)
                        // CONDICI√ìN 2: Que el link no sea texto vac√≠o
                        // CONDICI√ìN 3: Que tenga nombres
                        return item.link && item.link.trim() !== "" && 
                               ((item.esposo && item.esposo.length > 1) || (item.esposa && item.esposa.length > 1));
                    }).map(p => ({
                        busqueda: normalizar(p.esposo + " " + p.esposa),
                        nombreMostar: `${p.esposo} & ${p.esposa}`,
                        fila: p.fila,
                        yaEntro: false 
                    }));

                    status.innerHTML = `‚úÖ <b>LISTO:</b> ${invitados.length} parejas con QR.`;
                    status.className = "text-sm text-green-400 font-bold p-4 bg-gray-900";
                    
                    configurarCamara();
                } else {
                    status.innerHTML = "‚ùå Error datos: " + json.message;
                    status.className = "text-sm text-red-500 font-bold p-4";
                }
            } catch (e) {
                // Reintento de seguridad
                console.log("Reintentando con listar_envios...");
                fetch(`${URL_SCRIPT}?accion=listar_envios`)
                    .then(r => r.json())
                    .then(d => {
                        if(d.result === "success") {
                            invitados = d.message.filter(item => item.link && item.link.trim() !== "" && ((item.esposo && item.esposo.length > 1) || (item.esposa && item.esposa.length > 1)))
                                .map(p => ({ busqueda: normalizar(p.esposo + " " + p.esposa), nombreMostar: `${p.esposo} & ${p.esposa}`, fila: p.fila, yaEntro: false }));
                            status.innerHTML = `‚úÖ <b>LISTO:</b> ${invitados.length} parejas con QR.`;
                            status.className = "text-sm text-green-400 font-bold p-4 bg-gray-900";
                            configurarCamara();
                        }
                    }).catch(err => {
                        status.innerHTML = "‚ùå Error de conexi√≥n.";
                    });
            }
        }

        function normalizar(txt) {
            if(!txt) return "";
            return txt.toString().toLowerCase()
                .replace("registro:", "")
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-z0-9 ]/g, "")
                .trim();
        }

        function alLeerQR(textoQR) {
            if (!escaneando) return;
            
            escaneando = false; 
            if(scanner) scanner.pause();

            const qrLimpio = normalizar(textoQR);
            console.log("QR:", qrLimpio);

            const encontrado = invitados.find(p => {
                if(!p.busqueda) return false;
                return p.busqueda.includes(qrLimpio) || qrLimpio.includes(p.busqueda);
            });

            if (encontrado) {
                if (encontrado.yaEntro) {
                    mostrarResultado("warning", "‚ö†Ô∏è YA INGRES√ì", encontrado.nombreMostar, "Esta entrada ya fue utilizada (Localmente).");
                } else {
                    mostrarResultado("success", "‚úÖ BIENVENIDOS", encontrado.nombreMostar, "Pase autorizado.");
                    encontrado.yaEntro = true;
                    // Intentamos marcar en servidor (si falla, no importa)
                    fetch(`${URL_SCRIPT}?accion=marcar_asistencia&fila=${encontrado.fila}`, {method: 'POST'}).catch(e=>{});
                }
            } else {
                mostrarResultado("error", "üö´ NO ENCONTRADO", "QR Desconocido", "Verifique que sea de este evento.");
            }
        }

        function mostrarResultado(tipo, titulo, nombre, msg) {
            const overlay = document.getElementById('overlay');
            const icon = document.getElementById('icon');
            
            overlay.className = "fixed inset-0 flex flex-col items-center justify-center p-6 text-center z-50 text-white " + tipo;
            icon.innerText = (tipo === "success") ? "‚ú®" : (tipo === "warning" ? "‚úã" : "üö´");
            
            document.getElementById('title').innerText = titulo;
            document.getElementById('name').innerText = nombre;
            document.getElementById('msg').innerText = msg;
            
            overlay.classList.remove('hidden');
        }

        function resetScanner() {
            document.getElementById('overlay').classList.add('hidden');
            escaneando = true;
            if(scanner) scanner.resume();
        }

        function configurarCamara() {
            scanner = new Html5QrcodeScanner("reader", { 
                fps: 10, 
                qrbox: {width: 250, height: 250},
                aspectRatio: 1.0,
                showTorchButtonIfSupported: true
            });
            scanner.render(alLeerQR, (err)=>{});
        }

        window.onload = iniciarSistema;

    </script>
</body>
</html>
