<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Entrada - Cena Parejas</title>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        body { background-color: #1a202c; color: white; font-family: sans-serif; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; background: #000; margin-bottom: 20px; border: 2px solid #4a5568; }
        
        .success-screen { background-color: #22c55e; } 
        .error-screen { background-color: #ef4444; }   
        .warning-screen { background-color: #f59e0b; } 
        
        #html5-qrcode-button-camera-stop, #html5-qrcode-button-camera-start, #html5-qrcode-button-camera-permission {
            padding: 8px 16px; border-radius: 5px; background: #3b82f6; color: white; border: none; margin: 5px; cursor: pointer;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div class="p-4 bg-gray-900 shadow-md z-10 text-center border-b border-gray-800">
        <h1 class="text-xl font-bold text-red-500 tracking-wider">SCANNER ENTRADA ‚ù§Ô∏è</h1>
        <p id="status-db" class="text-xs text-gray-400 mt-1 animate-pulse">Conectando...</p>
    </div>

    <div class="flex-grow flex flex-col items-center justify-start pt-6 px-4 overflow-y-auto">
        <div id="reader"></div>
        <div class="text-sm text-gray-400 text-center mt-2 px-4 bg-gray-800 p-2 rounded">
            üí° Si no enfoca, cambia la c√°mara en el men√∫ superior.
        </div>
    </div>

    <div id="result-overlay" class="fixed inset-0 hidden flex flex-col items-center justify-center text-center p-6 z-50 transition-all duration-300">
        <div id="result-icon" class="text-8xl mb-4 transform hover:scale-110 transition-transform"></div>
        <h2 id="result-title" class="text-4xl font-bold mb-2 uppercase drop-shadow-md"></h2>
        <p id="result-name" class="text-2xl font-semibold drop-shadow-sm text-white border-b-2 border-white/20 pb-2 mb-2"></p>
        <p id="result-msg" class="mt-2 text-lg opacity-90 text-white font-medium"></p>
        
        <button onclick="cerrarOverlay()" class="mt-8 bg-white text-gray-900 font-bold py-4 px-12 rounded-full shadow-2xl text-lg hover:bg-gray-100 active:scale-95 transition-all">
            ESCANEAR SIGUIENTE
        </button>
    </div>

    <script>
        // ==========================================
        // ‚ö†Ô∏è PEGA AQU√ç TU URL (LA MISMA QUE EN ENVIOS.HTML)
        // ==========================================
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyBLSQ9UTUL9cD7CtwAb9ZqecvDKK2DN3XgJbZ4IMtADoucQpYG1Cm7xnuFIC28EzhI8Q/exec'; 
        // ==========================================

        let listaInvitados = [];
        let html5QrcodeScanner = null;
        let isScanning = true;

        // --- 1. CARGA DE BASE DE DATOS INTELIGENTE ---
        async function cargarBaseDatos() {
            const statusEl = document.getElementById('status-db');
            try {
                // Pedimos "listar_envios" (o "listar_todo") porque sabemos que esa funci√≥n YA EXISTE y funciona en tu script actual
                // No usamos "listar_asistencia" si tu script viejo no la tiene.
                const response = await fetch(`${APPS_SCRIPT_URL}?accion=listar_envios`);
                const data = await response.json();
                
                if (data.result === "success") {
                    // AQU√ç EST√Å LA MAGIA: FILTRADO EN EL NAVEGADOR
                    // Recibimos la lista sucia y la limpiamos aqu√≠ mismo.
                    const listaCruda = data.message;
                    
                    listaInvitados = listaCruda.filter(item => {
                        // Filtro: Debe tener Link Y tener Nombre (Esposo o Esposa)
                        return item.link && item.link.length > 5 && 
                               ((item.esposo && item.esposo.trim().length > 1) || (item.esposa && item.esposa.trim().length > 1));
                    }).map(item => {
                        // Transformamos al formato que necesita el esc√°ner
                        return {
                            fila: item.fila,
                            nombres: `${item.esposo} & ${item.esposa}`,
                            // Si tu script viejo no manda "asistio", asumimos falso por ahora (o lo manejamos luego)
                            asistio: false // Por defecto
                        };
                    });

                    statusEl.innerHTML = `‚úÖ <b>LISTO:</b> ${listaInvitados.length} parejas reales cargadas.`;
                    statusEl.classList.remove('animate-pulse', 'text-gray-400');
                    statusEl.classList.add('text-green-400');
                    
                    iniciarScanner(); 
                } else {
                    throw new Error(data.message);
                }
            } catch (e) {
                // Intento alternativo por si la acci√≥n se llama "listar_todo"
                if(e.message && e.message.includes("Acci√≥n desconocida")) {
                     console.warn("Reintentando con listar_todo...");
                     fetch(`${APPS_SCRIPT_URL}?accion=listar_todo`)
                        .then(r => r.json())
                        .then(d => {
                             if(d.result === "success") {
                                 // Repetimos l√≥gica de limpieza
                                 const listaCruda = d.message;
                                 listaInvitados = listaCruda.filter(item => item.link && item.link.length > 5 && ((item.esposo && item.esposo.trim().length > 1) || (item.esposa && item.esposa.trim().length > 1)))
                                     .map(item => ({ fila: item.fila, nombres: `${item.esposo} & ${item.esposa}`, asistio: false }));
                                 
                                 statusEl.innerHTML = `‚úÖ <b>LISTO:</b> ${listaInvitados.length} parejas reales.`;
                                 statusEl.classList.remove('animate-pulse', 'text-gray-400');
                                 statusEl.classList.add('text-green-400');
                                 iniciarScanner();
                             }
                        }).catch(err => {
                            mostrarErrorCarga(err);
                        });
                } else {
                    mostrarErrorCarga(e);
                }
            }
        }

        function mostrarErrorCarga(e) {
            const statusEl = document.getElementById('status-db');
            statusEl.innerHTML = "‚ùå <b>ERROR:</b> Fallo de conexi√≥n.";
            statusEl.classList.remove('text-gray-400');
            statusEl.classList.add('text-red-500');
            console.error(e);
        }

        // --- 2. NORMALIZADOR DE TEXTO ---
        function normalizar(texto) {
            if (!texto) return "";
            return texto.toString()
                .toLowerCase()
                .replace("registro:", "")
                .trim()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/\s+/g, " ");
        }

        // --- 3. AL ESCANEAR ---
        function onScanSuccess(decodedText, decodedResult) {
            if (!isScanning) return; 
            
            isScanning = false; 
            if(html5QrcodeScanner) html5QrcodeScanner.pause();

            const qrLimpio = normalizar(decodedText);
            console.log("Le√≠do:", qrLimpio);

            const encontrado = listaInvitados.find(invitado => {
                const dbNombre = normalizar(invitado.nombres);
                return dbNombre.includes(qrLimpio) || qrLimpio.includes(dbNombre);
            });

            if (encontrado) {
                if (encontrado.asistio) {
                    mostrarPantalla("warning", "‚ö†Ô∏è YA INGRES√ì", encontrado.nombres, "Esta pareja ya fue marcada (Localmente).");
                } else {
                    mostrarPantalla("success", "‚úÖ BIENVENIDOS", encontrado.nombres, "Pase v√°lido.");
                    // Intentamos marcar asistencia en backend (si la funci√≥n existe)
                    registrarEntradaBackend(encontrado.fila);
                    encontrado.asistio = true; 
                }
            } else {
                mostrarPantalla("error", "‚ùå NO ENCONTRADO", "QR Desconocido", "Verifique el pase.");
            }
        }

        function onScanFailure(error) {}

        function mostrarPantalla(tipo, titulo, nombre, mensaje) {
            const overlay = document.getElementById('result-overlay');
            const icon = document.getElementById('result-icon');
            overlay.className = "fixed inset-0 flex flex-col items-center justify-center text-center p-6 z-50 transition-all duration-300 text-white";
            
            if (tipo === 'success') {
                overlay.classList.add('success-screen');
                icon.innerText = "‚ú®";
            } else if (tipo === 'error') {
                overlay.classList.add('error-screen');
                icon.innerText = "üö´";
            } else {
                overlay.classList.add('warning-screen');
                icon.innerText = "‚úã";
            }

            document.getElementById('result-title').innerText = titulo;
            document.getElementById('result-name').innerText = nombre;
            document.getElementById('result-msg').innerText = mensaje;
            overlay.classList.remove('hidden');
        }

        function cerrarOverlay() {
            document.getElementById('result-overlay').classList.add('hidden');
            isScanning = true;
            if(html5QrcodeScanner) html5QrcodeScanner.resume();
        }

        // Intento de marcar asistencia, aunque el backend viejo puede no soportarlo, 
        // al menos el scanner valida visualmente.
        async function registrarEntradaBackend(fila) {
            try {
                await fetch(`${APPS_SCRIPT_URL}?accion=marcar_asistencia&fila=${fila}`, {method: 'POST'});
            } catch (e) {
                console.log("Backend no soporta marca, o error de red.");
            }
        }

        function iniciarScanner() {
            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader", { fps: 10, qrbox: {width: 250, height: 250}, aspectRatio: 1.0, showTorchButtonIfSupported: true }, false);
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        }

        window.onload = cargarBaseDatos;

    </script>
</body>
</html>
