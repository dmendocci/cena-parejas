<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Admin - Love Night</title>
    <style>
        :root { --vino: #741b47; --dorado: #d4af37; --crema: #fcf9f2; --texto: #4a2c38; --verde: #27ae60; --azul: #25D366; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--crema); color: var(--texto); padding: 20px; }
        .container { max-width: 1300px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; border-top: 6px solid var(--dorado); }
        h1 { color: var(--vino); text-align: center; text-transform: uppercase; margin-bottom: 30px; }
        
        .filters-box { background: #fff; padding: 20px; border: 1px solid #eaddd5; border-radius: 8px; margin-bottom: 20px; }
        .row { display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 250px; }
        label { color: var(--vino); font-weight: bold; font-size: 0.9rem; display: block; margin-bottom: 5px; }
        select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; outline: none; }
        
        /* ESTILOS DE BOTONES DIN√ÅMICOS */
        .btn-step-1 { 
            background: var(--dorado); color: white; border: none; padding: 10px; 
            border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; 
            transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-step-1:hover { background: #b59020; transform: translateY(-1px); }

        .btn-step-2 { 
            background: var(--azul); color: white; border: none; padding: 10px; 
            border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; 
            animation: pulse 2s infinite; /* Llama la atenci√≥n para el 2do clic */
        }
        .btn-step-2:hover { background: #1ebc57; }

        .btn-done { 
            background: var(--vino) !important; color: white !important; 
            cursor: default !important; opacity: 0.8; width: 100%; padding: 10px; 
            border: none; border-radius: 5px; font-weight: bold;
        }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(37, 211, 102, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0); } }
        
        .table-wrap { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: var(--vino); color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
        
        .tag { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }
        .tag-ok { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .tag-pending { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .btn-reset { background: #eee; color: #555; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>Love Night - Registro</h1>
    <div id="loading" style="text-align:center; padding:40px;">‚è≥ Cargando invitados...</div>
    
    <div id="mainContent" style="display:none;">
        <div class="filters-box">
            <div class="row">
                <div class="col"><label>üí∞ Pago</label><select id="fPago" onchange="apply()"><option value="all">Todos</option><option value="no">Pendientes</option><option value="yes">Pagados</option></select></div>
                <div class="col"><label>‚úÖ Check-in</label><select id="fCheck" onchange="apply()"><option value="def">Seleccione...</option><option value="ok">Confirmado</option><option value="no">Sin confirmar</option><option value="all">Todos</option></select></div>
            </div>
            <div class="row">
                <div class="col"><label>ü§µ Esposo</label><select id="fEsposo" onchange="sync('man')"><option value="">-- Todos --</option></select></div>
                <div class="col"><label>üë∞ Esposa</label><select id="fEsposa" onchange="sync('woman')"><option value="">-- Todas --</option></select></div>
            </div>
            <div style="margin-top:10px; text-align:right;">
                <button class="btn-reset" onclick="resetFilters()" style="float:left;">üîÑ Limpiar</button>
                <span id="count" style="font-weight:bold; color:#777;">0 reg.</span>
            </div>
        </div>
        <div class="table-wrap"><table id="tab"><thead><tr id="th"></tr></thead><tbody id="tb"></tbody></table></div>
    </div>
</div>
<div id="version">v21.0 - Flujo Secuencial</div>

<script>
    // URL DEFINITIVA
    const API_URL = "https://script.google.com/macros/s/AKfycbxOMGhRpNPvuhHcsXTZnrMrNoLRqMQYzWhRA3MZUjUYznxKTYvDb94MG2i6-acQdivS/exec";
    const SID = "1slBfBNMEVgWOewNphlFi82fQbs7Y6GtD6Hcplj2D8do";
    const GID = "1064363108";

    const I_MAN=1, I_TEL1=2, I_WOM=3, I_TEL2=4, I_PAY=7, I_CHK=8; 
    const HEADERS = { [I_MAN]:"Esposo", [I_WOM]:"Esposa", [I_TEL1]:"Tel. √âl", [I_TEL2]:"Tel. Ella", [I_PAY]:"Pago", [I_CHK]:"Check-in" };

    let data = [], loaded = false;

    function load() {
        const s = document.createElement('script');
        s.src = `https://docs.google.com/spreadsheets/d/${SID}/gviz/tq?tqx=responseHandler:proc&gid=${GID}&t=${Date.now()}`;
        document.body.appendChild(s);
    }
    load(); setInterval(() => load(), 6000);

    window.proc = function(json) {
        if(!json || !json.table) return;
        data = json.table.rows.map(r => r.c.map(c => (c?.v || "").toString().trim()));
        
        const curMan = document.getElementById('fEsposo').value;
        const curWoman = document.getElementById('fEsposa').value;
        
        fillDrops();
        if(curMan) fixDrop('fEsposo', curMan);
        if(curWoman) fixDrop('fEsposa', curWoman);
        
        apply();
        if(!loaded) { document.getElementById('loading').style.display='none'; document.getElementById('mainContent').style.display='block'; loaded=true; }
    };

    function fillDrops() {
        const s1 = document.getElementById('fEsposo'), s2 = document.getElementById('fEsposa');
        const l1 = [...new Set(data.map(r => r[I_MAN]))].filter(Boolean).sort();
        const l2 = [...new Set(data.map(r => r[I_WOM]))].filter(Boolean).sort();
        if(s1.options.length > 1 && s1.options.length === l1.length + 1) return;
        const sel1 = s1.value, sel2 = s2.value;
        s1.innerHTML = '<option value="">-- Todos --</option>'; s2.innerHTML = '<option value="">-- Todas --</option>';
        l1.forEach(x => s1.add(new Option(x,x))); l2.forEach(x => s2.add(new Option(x,x)));
        if(l1.includes(sel1)) s1.value = sel1; if(l2.includes(sel2)) s2.value = sel2;
    }

    function sync(who) {
        const s1 = document.getElementById('fEsposo'), s2 = document.getElementById('fEsposa');
        if(who === 'man') { if(!s1.value) s2.value = ""; else { const f = data.find(r => r[I_MAN] === s1.value); if(f) s2.value = f[I_WOM]; } }
        if(who === 'woman') { if(!s2.value) s1.value = ""; else { const f = data.find(r => r[I_WOM] === s2.value); if(f) s1.value = f[I_MAN]; } }
        apply();
    }
    function resetFilters() { document.getElementById('fPago').value="all"; document.getElementById('fCheck').value="def"; document.getElementById('fEsposo').value=""; document.getElementById('fEsposa').value=""; apply(); }
    function fixDrop(id, v) { const d = document.getElementById(id); if(d.value !== v) d.value = ""; }

    function apply() {
        const fp = document.getElementById('fPago').value, fc = document.getElementById('fCheck').value;
        const fm = document.getElementById('fEsposo').value, fw = document.getElementById('fEsposa').value;
        const res = data.filter(r => {
            const p = r[I_PAY].toLowerCase();
            if(fp === 'no' && p !== "") return false;
            if(fp === 'yes' && !p.includes("pagado")) return false;
            const c = r[I_CHK];
            if(fc === 'confirmado' && c !== "OK") return false;
            if(fc === 'sin_confirmar' && c !== "") return false;
            if(fm && r[I_MAN] !== fm) return false;
            if(fw && r[I_WOM] !== fw) return false;
            return true;
        });
        document.getElementById('count').innerText = res.length + " reg.";
        draw(res);
    }

    function draw(list) {
        const th = document.getElementById('th'), tb = document.getElementById('tb');
        th.innerHTML = ''; tb.innerHTML = '';
        [I_MAN, I_WOM, I_TEL1, I_TEL2, I_PAY, I_CHK].forEach(i => th.insertAdjacentHTML('beforeend', `<th>${HEADERS[i]}</th>`));
        th.insertAdjacentHTML('beforeend', `<th>Acci√≥n</th>`);

        list.forEach(r => {
            let tr = document.createElement('tr');
            [I_MAN, I_WOM, I_TEL1, I_TEL2, I_PAY, I_CHK].forEach(i => {
                let h = r[i];
                if(i===I_PAY) h = h.toLowerCase().includes("pagado") ? `<span class="tag tag-ok">Pagado</span>` : `<span class="tag tag-pending">Pendiente</span>`;
                if(i===I_CHK) h = h==="OK" ? `<span class="tag tag-ok">OK</span>` : `-`;
                tr.insertAdjacentHTML('beforeend', `<td>${h}</td>`);
            });
            let td = document.createElement('td');
            let isPaid = r[I_PAY].toLowerCase().includes("pagado");
            
            if(isPaid) {
                // Si ya est√° pagado, bot√≥n final
                let b = document.createElement('button'); 
                b.className = "btn-done"; 
                b.innerText = "‚úÖ Registro Completado";
                td.appendChild(b);
            } else {
                // Si no, iniciamos el flujo secuencial
                // Creamos un contenedor para el bot√≥n
                let container = document.createElement('div');
                container.id = `btn-container-${r[I_MAN].replace(/\s/g,'')}`;
                
                let b = document.createElement('button'); 
                b.className = "btn-step-1"; 
                b.innerText = `‚úÖ Validar y Enviar a ${r[I_MAN].split(' ')[0]}`; // Solo primer nombre
                b.onclick = () => startSequence(b, r, container, tr);
                
                container.appendChild(b);
                td.appendChild(container);
            }
            tr.appendChild(td); tb.appendChild(tr);
        });
    }

    // FLUJO SECUENCIAL (EL TRUCO PARA EVITAR BLOQUEOS)
    function startSequence(btn1, row, container, tr) {
        // 1. Feedback visual inmediato
        btn1.innerText = "‚è≥ Guardando...";
        btn1.disabled = true;

        // 2. Disparamos guardado en background (No esperamos respuesta para abrir ventana)
        const form = new URLSearchParams(); form.append('accion', 'pagar'); form.append('esposo', row[I_MAN]); form.append('esposa', row[I_WOM]);
        fetch(API_URL, { method: 'POST', mode: 'no-cors', body: form });

        // 3. Abrimos WhatsApp del Esposo (Inmediato = No bloqueo)
        sendWA(row, 'man');

        // 4. Actualizamos UI para el Paso 2
        setTimeout(() => {
            // Marcamos pagado visualmente
            row[I_PAY] = "Pagado";
            tr.cells[4].innerHTML = `<span class="tag tag-ok">Pagado</span>`;
            
            // Cambiamos el bot√≥n por el Paso 2
            container.innerHTML = ''; // Limpiar bot√≥n viejo
            
            let btn2 = document.createElement('button');
            btn2.className = "btn-step-2";
            btn2.innerText = `üì≤ Falta enviar a ${row[I_WOM].split(' ')[0]}`;
            btn2.onclick = () => finishSequence(btn2, row, container);
            
            container.appendChild(btn2);
        }, 1000); // Peque√±a pausa natural
    }

    function finishSequence(btn2, row, container) {
        // 1. Abrimos WhatsApp de la Esposa
        sendWA(row, 'woman');
        
        // 2. Finalizamos
        container.innerHTML = '';
        let done = document.createElement('button');
        done.className = "btn-done";
        done.innerText = "‚úÖ Listo";
        container.appendChild(done);
        
        load(); // Recarga final segura
    }

    function sendWA(row, who) {
        const link = `https://dmendocci.github.io/cena-parejas/pase.html?esposo=${encodeURIComponent(row[I_MAN])}&esposa=${encodeURIComponent(row[I_WOM])}`;
        const txt = `¬°Hola! Su registro a "Love Night" est√° confirmado.\n\nSu pase de acceso:\n${link}\n\n¬°Los esperamos!`;
        
        let phone = (who==='man' ? row[I_TEL1] : row[I_TEL2]).replace(/\D/g,'');
        
        if(phone.length > 5) {
            window.open(`https://web.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(txt)}`, '_blank');
        } else {
            alert(`‚ö†Ô∏è No hay n√∫mero v√°lido para ${who==='man' ? '√©l' : 'ella'}.`);
        }
    }
</script>
</body>
</html>
