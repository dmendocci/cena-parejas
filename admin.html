<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Admin - Love Night</title>
    <style>
        :root { 
            --vino: #741b47; --dorado: #d4af37; --crema: #fcf9f2; 
            --texto: #4a2c38; --verde: #27ae60; --gris: #607d8b; 
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--crema); color: var(--texto); padding: 20px; }
        .container { max-width: 1300px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; border-top: 6px solid var(--dorado); }
        h1 { color: var(--vino); text-align: center; text-transform: uppercase; margin-bottom: 20px; font-size: 1.5rem; }
        
        .filters-box { background: #fff; padding: 15px; border: 1px solid #eaddd5; border-radius: 8px; margin-bottom: 20px; }
        .row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 200px; }
        label { color: var(--vino); font-weight: bold; font-size: 0.9rem; display: block; margin-bottom: 5px; }
        select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        
        .btn-validate { 
            background: var(--dorado); color: white; border: none; padding: 10px; 
            border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.2s;
        }
        
        .btn-wa { 
            background: #25D366; color: white; border: none; padding: 8px 10px; 
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.85rem; 
            margin: 2px; display: inline-flex; align-items: center; gap: 5px;
            width: 100%; justify-content: center;
        }
        .btn-wa-sent { background: var(--gris); border: 1px solid #455a64; opacity: 0.9; }

        .btn-reset { background: #eee; color: #555; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        .table-wrap { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: var(--vino); color: white; padding: 12px; text-align: left; font-size: 0.9rem; }
        td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; font-size: 0.9rem; }
        
        .tag { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; display: inline-block; }
        .tag-ok { background: #d4edda; color: #155724; }
        .tag-pending { background: #fff3cd; color: #856404; }
        .actions-cell { display: flex; flex-direction: column; gap: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Love Night - Registro</h1>
    <div id="loading" style="text-align:center; padding:40px;">‚è≥ Cargando...</div>
    
    <div id="mainContent" style="display:none;">
        <div class="filters-box">
            <div class="row">
                <div class="col"><label>üí∞ Pago</label><select id="fPago" onchange="apply()"><option value="all">Todos</option><option value="no">Pendientes</option><option value="yes">Pagados</option></select></div>
                <div class="col"><label>‚úÖ Check-in</label><select id="fCheck" onchange="apply()"><option value="def">Seleccione...</option><option value="ok">Confirmado</option><option value="no">Sin confirmar</option><option value="all">Todos</option></select></div>
            </div>
            <div class="row">
                <div class="col"><label>ü§µ Esposo</label><select id="fEsposo" onchange="sync('man')"><option value="">-- Todos --</option></select></div>
                <div class="col"><label>üë∞ Esposa</label><select id="fEsposa" onchange="sync('woman')"><option value="">-- Todas --</option></select></div>
            </div>
            <div style="margin-top:10px; text-align:right;">
                <button class="btn-reset" onclick="resetFilters()" style="float:left;">üîÑ Limpiar</button>
                <span id="count" style="font-weight:bold; color:#777;">0 reg.</span>
            </div>
        </div>
        <div class="table-wrap"><table id="tab"><thead><tr id="th"></tr></thead><tbody id="tb"></tbody></table></div>
    </div>
</div>
<div id="version">v24.0 - Auto 504 Fix</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxOMGhRpNPvuhHcsXTZnrMrNoLRqMQYzWhRA3MZUjUYznxKTYvDb94MG2i6-acQdivS/exec";
    const SID = "1slBfBNMEVgWOewNphlFi82fQbs7Y6GtD6Hcplj2D8do";
    const GID = "1064363108";

    const I_MAN=1, I_TEL1=2, I_WOM=3, I_TEL2=4, I_PAY=7, I_CHK=8; 
    const HEADERS = { [I_MAN]:"Esposo", [I_WOM]:"Esposa", [I_TEL1]:"Tel. √âl", [I_TEL2]:"Tel. Ella", [I_PAY]:"Pago", [I_CHK]:"Check-in" };

    let data = [], loaded = false;
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    function load() {
        const s = document.createElement('script');
        s.src = `https://docs.google.com/spreadsheets/d/${SID}/gviz/tq?tqx=responseHandler:proc&gid=${GID}&t=${Date.now()}`;
        document.body.appendChild(s);
    }
    load(); setInterval(() => load(), 6000);

    window.proc = function(json) {
        if(!json || !json.table) return;
        data = json.table.rows.map(r => r.c.map(c => (c?.v || "").toString().trim()));
        
        const curMan = document.getElementById('fEsposo').value;
        const curWoman = document.getElementById('fEsposa').value;
        
        fillDrops();
        if(curMan) fixDrop('fEsposo', curMan);
        if(curWoman) fixDrop('fEsposa', curWoman);
        
        apply();
        if(!loaded) { document.getElementById('loading').style.display='none'; document.getElementById('mainContent').style.display='block'; loaded=true; }
    };

    function fillDrops() {
        const s1 = document.getElementById('fEsposo'), s2 = document.getElementById('fEsposa');
        const l1 = [...new Set(data.map(r => r[I_MAN]))].filter(Boolean).sort();
        const l2 = [...new Set(data.map(r => r[I_WOM]))].filter(Boolean).sort();
        if(s1.options.length > 1 && s1.options.length === l1.length + 1) return;
        const sel1 = s1.value, sel2 = s2.value;
        s1.innerHTML = '<option value="">-- Todos --</option>'; s2.innerHTML = '<option value="">-- Todas --</option>';
        l1.forEach(x => s1.add(new Option(x,x))); l2.forEach(x => s2.add(new Option(x,x)));
        if(l1.includes(sel1)) s1.value = sel1; if(l2.includes(sel2)) s2.value = sel2;
    }

    function sync(who) {
        const s1 = document.getElementById('fEsposo'), s2 = document.getElementById('fEsposa');
        if(who === 'man') { if(!s1.value) s2.value = ""; else { const f = data.find(r => r[I_MAN] === s1.value); if(f) s2.value = f[I_WOM]; } }
        if(who === 'woman') { if(!s2.value) s1.value = ""; else { const f = data.find(r => r[I_WOM] === s2.value); if(f) s1.value = f[I_MAN]; } }
        apply();
    }
    function resetFilters() { document.getElementById('fPago').value="all"; document.getElementById('fCheck').value="def"; document.getElementById('fEsposo').value=""; document.getElementById('fEsposa').value=""; apply(); }
    function fixDrop(id, v) { const d = document.getElementById(id); if(d.value !== v) d.value = ""; }

    function apply() {
        const fp = document.getElementById('fPago').value, fc = document.getElementById('fCheck').value;
        const fm = document.getElementById('fEsposo').value, fw = document.getElementById('fEsposa').value;
        const res = data.filter(r => {
            const p = r[I_PAY].toLowerCase();
            if(fp === 'no' && p !== "") return false;
            if(fp === 'yes' && !p.includes("pagado")) return false;
            const c = r[I_CHK];
            if(fc === 'confirmado' && c !== "OK") return false;
            if(fc === 'sin_confirmar' && c !== "") return false;
            if(fm && r[I_MAN] !== fm) return false;
            if(fw && r[I_WOM] !== fw) return false;
            return true;
        });
        document.getElementById('count').innerText = res.length + " reg.";
        draw(res);
    }

    function draw(list) {
        const th = document.getElementById('th'), tb = document.getElementById('tb');
        th.innerHTML = ''; tb.innerHTML = '';
        [I_MAN, I_WOM, I_TEL1, I_TEL2, I_PAY, I_CHK].forEach(i => th.insertAdjacentHTML('beforeend', `<th>${HEADERS[i]}</th>`));
        th.insertAdjacentHTML('beforeend', `<th>Acci√≥n</th>`);

        list.forEach(r => {
            let tr = document.createElement('tr');
            [I_MAN, I_WOM, I_TEL1, I_TEL2, I_PAY, I_CHK].forEach(i => {
                let h = r[i];
                if(i===I_PAY) h = h.toLowerCase().includes("pagado") ? `<span class="tag tag-ok">Pagado</span>` : `<span class="tag tag-pending">Pendiente</span>`;
                if(i===I_CHK) h = h==="OK" ? `<span class="tag tag-ok">OK</span>` : `-`;
                tr.insertAdjacentHTML('beforeend', `<td>${h}</td>`);
            });
            let td = document.createElement('td');
            let isPaid = r[I_PAY].toLowerCase().includes("pagado");
            
            if(isPaid) {
                let div = document.createElement('div');
                div.className = "actions-cell";
                div.appendChild(createWaBtn(r, 'man'));
                div.appendChild(createWaBtn(r, 'woman'));
                td.appendChild(div);
            } else {
                let b = document.createElement('button'); 
                b.className = "btn-validate"; 
                b.innerText = "‚úÖ Validar"; 
                b.onclick = () => doPay(b, r, td);
                td.appendChild(b);
            }
            tr.appendChild(td); tb.appendChild(tr);
        });
    }

    function createWaBtn(row, who) {
        let b = document.createElement('button');
        let name = who==='man' ? `√âl: ${row[I_MAN].split(' ')[0]}` : `Ella: ${row[I_WOM].split(' ')[0]}`;
        
        // LOGICA DE TELEFONO (CORRECCI√ìN HONDURAS)
        let rawPhone = who==='man' ? row[I_TEL1] : row[I_TEL2];
        let phone = (rawPhone || "").toString().replace(/\D/g,'');
        
        // Si tiene 8 d√≠gitos, le ponemos 504
        if(phone.length === 8) phone = "504" + phone;

        b.className = "btn-wa"; 
        b.innerHTML = `üì≤ Enviar a ${name}`;
        b.title = `Enviar a +${phone}`;
        
        let key = `sent_${row[I_MAN]}_${who}`;
        if(localStorage.getItem(key)) {
            b.className = "btn-wa btn-wa-sent";
            b.innerHTML = `‚úîÔ∏è Reenviar a ${name}`;
        }

        if(phone.length < 8) { // M√≠nimo 8 d√≠gitos (sin o con 504)
            b.style.opacity = "0.5"; b.style.cursor = "not-allowed"; b.title = "N√∫mero inv√°lido (<8 d√≠gitos)";
        } else {
            b.onclick = () => {
                sendWA(row, who, phone);
                b.className = "btn-wa btn-wa-sent";
                b.innerHTML = `‚úîÔ∏è Reenviar a ${name}`;
                localStorage.setItem(key, "true");
            };
        }
        return b;
    }

    function doPay(btn, row, tdElement) {
        btn.innerText = "‚è≥ ..."; btn.disabled = true;
        const form = new URLSearchParams(); form.append('accion', 'pagar'); form.append('esposo', row[I_MAN]); form.append('esposa', row[I_WOM]);
        
        fetch(API_URL, { method: 'POST', mode: 'no-cors', body: form }).then(() => {
            setTimeout(() => {
                row[I_PAY] = "Pagado";
                tdElement.innerHTML = '';
                let div = document.createElement('div');
                div.className = "actions-cell";
                div.appendChild(createWaBtn(row, 'man'));
                div.appendChild(createWaBtn(row, 'woman'));
                tdElement.appendChild(div);
                load();
            }, 1000);
        });
    }

    function sendWA(row, who, cleanPhone) {
        const link = `https://dmendocci.github.io/cena-parejas/pase.html?esposo=${encodeURIComponent(row[I_MAN])}&esposa=${encodeURIComponent(row[I_WOM])}`;
        const txt = `¬°Hola! Su registro a "Love Night" est√° confirmado.\n\nSu pase de acceso:\n${link}\n\n¬°Los esperamos!`;
        
        const baseUrl = isMobile ? "https://api.whatsapp.com/send" : "https://web.whatsapp.com/send";
        window.open(`${baseUrl}?phone=${cleanPhone}&text=${encodeURIComponent(txt)}`, '_blank');
    }
</script>
</body>
</html>
