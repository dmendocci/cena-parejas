<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Admin - Love Night</title>
    <style>
        :root { --vino: #741b47; --dorado: #d4af37; --crema: #fcf9f2; --texto: #4a2c38; --verde: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--crema); color: var(--texto); padding: 20px; }
        .container { max-width: 1300px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(116, 27, 71, 0.1); border-top: 6px solid var(--dorado); }
        h1 { color: var(--vino); text-align: center; text-transform: uppercase; margin-bottom: 30px; }
        
        .filters-box { background: #fff; padding: 20px; border: 1px solid #eaddd5; border-radius: 8px; margin-bottom: 20px; }
        .row { display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 250px; }
        label { color: var(--vino); font-weight: bold; font-size: 0.9rem; display: block; margin-bottom: 5px; }
        select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        
        .btn-action { background: var(--dorado); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
        .btn-action:hover { background: #b59020; }
        .btn-validated { background: var(--vino) !important; cursor: default !important; opacity: 0.8; }
        
        .table-wrap { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: var(--vino); color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        tr:hover { background: #faf5f7; }
        
        .tag { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }
        .tag-ok { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .tag-pending { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        
        #loading { text-align: center; padding: 40px; color: #999; font-size: 1.2rem; }
        .btn-reset { background: #eee; color: #555; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>Love Night - Registro</h1>
    <div id="loading">‚è≥ Cargando invitados...<br><small>Si no carga en 5s, revisa tu conexi√≥n.</small></div>
    
    <div id="mainContent" style="display:none;">
        <div class="filters-box">
            <div class="row">
                <div class="col"><label>üí∞ Pago</label><select id="fPago" onchange="apply()"><option value="all">Todos</option><option value="no">Pendientes</option><option value="yes">Pagados</option></select></div>
                <div class="col"><label>‚úÖ Check-in</label><select id="fCheck" onchange="apply()"><option value="def">Seleccione...</option><option value="ok">Confirmado</option><option value="no">Sin confirmar</option><option value="all">Todos</option></select></div>
            </div>
            <div class="row">
                <div class="col"><label>ü§µ Esposo</label><select id="fEsposo" onchange="sync('man')"><option value="">-- Todos --</option></select></div>
                <div class="col"><label>üë∞ Esposa</label><select id="fEsposa" onchange="sync('woman')"><option value="">-- Todas --</option></select></div>
            </div>
            <div style="margin-top:10px; text-align:right;">
                <button class="btn-reset" onclick="resetFilters()" style="float:left;">üîÑ Limpiar</button>
                <span id="count" style="font-weight:bold; color:#777;">0 reg.</span>
            </div>
        </div>
        <div class="table-wrap"><table id="tab"><thead><tr id="th"></tr></thead><tbody id="tb"></tbody></table></div>
    </div>
</div>
<div id="version">v18.0 - PreFilled</div>

<script>
    // ==========================================
    // ‚öôÔ∏è DATOS YA CONFIGURADOS (NO TOCAR)
    // ==========================================
    const API_URL = "https://script.google.com/macros/s/AKfycbxOMGhRpNPvuhHcsXTZnrMrNoLRqMQYzWhRA3MZUjUYznxKTYvDb94MG2i6-acQdivS/exec";
    const SID = "1slBfBNMEVgWOewNphlFi82fQbs7Y6GtD6Hcplj2D8do";
    const GID = "1064363108";
    // ==========================================

    const I_MAN=1, I_TEL1=2, I_WOM=3, I_TEL2=4, I_PAY=7, I_CHK=8; 
    const HEADERS = { [I_MAN]:"Esposo", [I_WOM]:"Esposa", [I_TEL1]:"Tel. √âl", [I_TEL2]:"Tel. Ella", [I_PAY]:"Pago", [I_CHK]:"Check-in" };

    let data = [], loaded = false;

    function load() {
        const t = new Date().getTime();
        // Usamos JSONP para saltar restricciones de navegador
        const s = document.createElement('script');
        s.src = `https://docs.google.com/spreadsheets/d/${SID}/gviz/tq?tqx=responseHandler:proc&gid=${GID}&t=${t}`;
        s.onerror = function() { 
             document.getElementById('loading').innerHTML = `
                <div style="color:red; font-weight:bold;">‚ùå Error de Carga</div>
                <p>No se puede leer la hoja. Posibles causas:</p>
                <ul style="text-align:left; display:inline-block;">
                    <li>Tienes un bloqueador de anuncios activo (Desact√≠valo).</li>
                    <li>La hoja dej√≥ de ser p√∫blica.</li>
                </ul>
             `;
        };
        document.body.appendChild(s);
    }
    load(); setInterval(() => load(), 6000);

    window.proc = function(json) {
        if(!json || !json.table) return;
        data = json.table.rows.map(r => r.c.map(c => (c?.v || "").toString().trim()));
        
        // Guardamos selecci√≥n actual para no perderla al refrescar
        const curMan = document.getElementById('fEsposo').value;
        const curWoman = document.getElementById('fEsposa').value;
        
        fillDrops();
        if(curMan) fixDrop('fEsposo', curMan);
        if(curWoman) fixDrop('fEsposa', curWoman);
        
        apply();
        if(!loaded) { document.getElementById('loading').style.display='none'; document.getElementById('mainContent').style.display='block'; loaded=true; }
    };

    function fillDrops() {
        const s1 = document.getElementById('fEsposo'), s2 = document.getElementById('fEsposa');
        const l1 = [...new Set(data.map(r => r[I_MAN]))].filter(Boolean).sort();
        const l2 = [...new Set(data.map(r => r[I_WOM]))].filter(Boolean).sort();
        
        // No reconstruir si ya tienen opciones y es la misma cantidad (evita parpadeo)
        if(s1.options.length > 1 && s1.options.length === l1.length + 1) return;

        const sel1 = s1.value, sel2 = s2.value;
        s1.innerHTML = '<option value="">-- Todos --</option>'; s2.innerHTML = '<option value="">-- Todas --</option>';
        l1.forEach(x => s1.add(new Option(x,x))); l2.forEach(x => s2.add(new Option(x,x)));
        if(l1.includes(sel1)) s1.value = sel1; if(l2.includes(sel2)) s2.value = sel2;
    }

    function sync(who) {
        const s1 = document.getElementById('fEsposo'), s2 = document.getElementById('fEsposa');
        if(who === 'man') { if(!s1.value) s2.value = ""; else { const f = data.find(r => r[I_MAN] === s1.value); if(f) s2.value = f[I_WOM]; } }
        if(who === 'woman') { if(!s2.value) s1.value = ""; else { const f = data.find(r => r[I_WOM] === s2.value); if(f) s1.value = f[I_MAN]; } }
        apply();
    }
    
    function resetFilters() {
        document.getElementById('fPago').value="all"; document.getElementById('fCheck').value="def";
        document.getElementById('fEsposo').value=""; document.getElementById('fEsposa').value="";
        apply();
    }
    
    function fixDrop(id, v) { const d = document.getElementById(id); if(d.value !== v) d.value = ""; }

    function apply() {
        const fp = document.getElementById('fPago').value, fc = document.getElementById('fCheck').value;
        const fm = document.getElementById('fEsposo').value, fw = document.getElementById('fEsposa').value;
        const res = data.filter(r => {
            const p = r[I_PAY].toLowerCase();
            if(fp === 'no' && p !== "") return false;
            if(fp === 'yes' && !p.includes("pagado")) return false;
            const c = r[I_CHK];
            if(fc === 'confirmado' && c !== "OK") return false;
            if(fc === 'sin_confirmar' && c !== "") return false;
            if(fm && r[I_MAN] !== fm) return false;
            if(fw && r[I_WOM] !== fw) return false;
            return true;
        });
        document.getElementById('count').innerText = res.length + " reg.";
        draw(res);
    }

    function draw(list) {
        const th = document.getElementById('th'), tb = document.getElementById('tb');
        th.innerHTML = ''; tb.innerHTML = '';
        [I_MAN, I_WOM, I_TEL1, I_TEL2, I_PAY, I_CHK].forEach(i => th.insertAdjacentHTML('beforeend', `<th>${HEADERS[i]}</th>`));
        th.insertAdjacentHTML('beforeend', `<th>Acci√≥n</th>`);

        list.forEach(r => {
            let tr = document.createElement('tr');
            [I_MAN, I_WOM, I_TEL1, I_TEL2, I_PAY, I_CHK].forEach(i => {
                let h = r[i];
                if(i===I_PAY) h = h.toLowerCase().includes("pagado") ? `<span class="tag tag-ok">Pagado</span>` : `<span class="tag tag-pending">Pendiente</span>`;
                if(i===I_CHK) h = h==="OK" ? `<span class="tag tag-ok">OK</span>` : `-`;
                tr.insertAdjacentHTML('beforeend', `<td>${h}</td>`);
            });
            let td = document.createElement('td');
            let isPaid = r[I_PAY].toLowerCase().includes("pagado");
            
            if(isPaid) {
                let b = document.createElement('button'); b.className = "btn-action btn-validated"; b.innerText = "‚úÖ Validado"; b.disabled = true;
                let re = document.createElement('button'); re.innerText = "üì≤"; re.style.marginLeft="5px"; re.style.cursor="pointer"; re.style.border="none"; re.style.background="transparent"; re.style.fontSize="1.2rem"; re.title = "Reenviar"; re.onclick = () => sendWA(r);
                td.appendChild(b); td.appendChild(re);
            } else {
                let b = document.createElement('button'); b.className = "btn-action"; b.innerText = "‚úÖ Validar y Enviar"; b.onclick = () => doPay(b, r, tr);
                td.appendChild(b);
            }
            tr.appendChild(td); tb.appendChild(tr);
        });
    }

    function doPay(btn, row, tr) {
        btn.innerText = "‚è≥ ..."; btn.disabled = true;
        const form = new URLSearchParams(); form.append('accion', 'pagar'); form.append('esposo', row[I_MAN]); form.append('esposa', row[I_WOM]);
        
        fetch(API_URL, { method: 'POST', mode: 'no-cors', body: form }).then(() => {
            setTimeout(() => {
                row[I_PAY] = "Pagado"; tr.cells[4].innerHTML = `<span class="tag tag-ok">Pagado</span>`;
                btn.className = "btn-action btn-validated"; btn.innerText = "‚úÖ Validado";
                let re = document.createElement('button'); re.innerText = "üì≤"; re.style.marginLeft="5px"; re.style.cursor="pointer"; re.style.border="none"; re.style.background="transparent"; re.style.fontSize="1.2rem"; re.onclick = () => sendWA(row);
                btn.parentNode.appendChild(re);
                sendWA(row); load();
            }, 1000);
        });
    }

    function sendWA(row) {
        const link = `https://dmendocci.github.io/cena-parejas/pase.html?esposo=${encodeURIComponent(row[I_MAN])}&esposa=${encodeURIComponent(row[I_WOM])}`;
        const txt = `¬°Hola! Su registro a "Love Night" est√° confirmado.\n\nSu pase de acceso:\n${link}\n\n¬°Los esperamos!`;
        let t1 = row[I_TEL1].replace(/\D/g,''), t2 = row[I_TEL2].replace(/\D/g,'');
        if(t1.length > 6) window.open(`https://web.whatsapp.com/send?phone=${t1}&text=${encodeURIComponent(txt)}`, '_blank');
        if(t2.length > 6) setTimeout(() => window.open(`https://web.whatsapp.com/send?phone=${t2}&text=${encodeURIComponent(txt)}`, '_blank'), 3000);
    }
</script>
</body>
</html>
