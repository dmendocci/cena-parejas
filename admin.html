<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>Admin - Love Night</title>
    <style>
        /* --- ESTILOS GENERALES --- */
        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: #fdfbf7; /* Tono crema suave/rom√°ntico */
            color: #4a4a4a; 
            padding: 20px; 
            margin: 0;
        }

        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            border-top: 6px solid #d4af37; /* Dorado elegante */
        }

        h1 { 
            text-align: center; 
            color: #d4af37; 
            margin-bottom: 30px; 
            font-weight: 300; 
            letter-spacing: 2px;
            text-transform: uppercase;
            font-size: 1.8rem;
        }

        /* --- SECCI√ìN DE FILTROS --- */
        .filters-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }

        .filter-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 250px;
        }

        label { 
            font-weight: bold; 
            display: block; 
            margin-bottom: 8px; 
            color: #2c3e50; 
            font-size: 0.9rem;
        }

        select { 
            width: 100%; 
            padding: 12px; 
            border-radius: 6px; 
            border: 1px solid #ccc; 
            background: white;
            font-size: 1rem;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        select:focus { border-color: #d4af37; outline: none; }

        /* --- TABLA --- */
        .table-responsive { overflow-x: auto; }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 900px; 
            margin-top: 10px;
        }

        th { 
            background: #2c3e50; 
            color: white; 
            padding: 15px; 
            text-align: left; 
            font-size: 0.95rem;
        }

        td { 
            padding: 14px; 
            border-bottom: 1px solid #eee; 
            vertical-align: middle; 
        }

        tr:nth-child(even) { background-color: #fcfcfc; }
        tr:hover { background-color: #f1f1f1; }

        /* --- ETIQUETAS DE ESTADO --- */
        .tag {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            display: inline-block;
        }
        .tag-pagado { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .tag-pendiente { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .tag-checkin { background: #cce5ff; color: #004085; border: 1px solid #b8daff; }

        #loading { text-align: center; padding: 50px; color: #888; font-size: 1.2rem; }
        .total-count { text-align: right; margin-top: 10px; color: #666; font-size: 0.9rem; }
        
        /* Ocultar elementos hasta cargar */
        #contentArea { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>Sistema de registro de cena de parejas - "Love Night"</h1>

    <div id="loading">‚è≥ Cargando base de datos segura...</div>

    <div id="contentArea">
        <div class="filters-panel">
            
            <div class="filter-row">
                <div class="filter-group">
                    <label>üí∞ Listar por estatus de pago:</label>
                    <select id="filterPago" onchange="applyFilters()">
                        <option value="todos">Todos</option>
                        <option value="pendientes">Pendientes (Sin pago)</option>
                        <option value="pagados">Pagados</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>‚úÖ Check in confirmado:</label>
                    <select id="filterCheckIn" onchange="applyFilters()">
                        <option value="default" selected>Seleccione una opci√≥n</option>
                        <option value="confirmado">Confirmado (OK)</option>
                        <option value="sin_confirmar">Sin confirmar</option>
                        <option value="todos">Todos</option>
                    </select>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label>ü§µ Nombre del esposo:</label>
                    <select id="filterEsposo" onchange="applyFilters('esposo')">
                        <option value="">-- Todos --</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>üë∞ Nombre de la esposa:</label>
                    <select id="filterEsposa" onchange="applyFilters('esposa')">
                        <option value="">-- Todas --</option>
                    </select>
                </div>
            </div>
            
            <div class="total-count" id="recordCount">Registros encontrados: 0</div>
        </div>

        <div class="table-responsive">
            <table id="dataTable">
                <thead>
                    <tr id="tableHead">
                        </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // ======================================================
    // ‚öôÔ∏è CONFIGURACI√ìN DE CONEXI√ìN
    // ======================================================
    const SHEET_ID = '1slBfBNMEVgWOewNphlFi82fQbs7Y6GtD6Hcplj2D8do';
    const SHEET_GID = '1064363108';

    // üó∫Ô∏è MAPEO DE COLUMNAS (Indices comienzan en 0)
    // Col A=0, B=1, C=2 ... H=7, I=8
    const COL_ESPOSO = 1;      // Columna B
    const COL_ESPOSA = 2;      // Columna C
    const COL_PAGO = 7;        // Columna H (Estatus Pago)
    const COL_CHECKIN = 8;     // Columna I (Check In) - Asumido como la siguiente a Pago
    
    // ======================================================

    let allData = [];
    let headers = [];
    let filteredData = [];

    // 1. CARGA DE DATOS (Anti-Cach√©)
    function loadDatabase() {
        const t = new Date().getTime(); 
        const script = document.createElement('script');
        // Usamos la API de visualizaci√≥n para leer datos sin exponer el link de edici√≥n
        script.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:processData&gid=${SHEET_GID}&t=${t}`;
        document.body.appendChild(script);
    }

    // 2. PROCESAMIENTO INICIAL
    window.processData = function(json) {
        // Extraer encabezados
        headers = json.table.cols.map(c => c.label || "Columna");
        
        // Extraer filas
        allData = json.table.rows.map(r => r.c.map(c => (c && c.v !== null) ? c.v : ""));
        
        // Inicializar Dropdowns de Nombres
        populateNameDropdowns();
        
        // Aplicar filtro inicial (mostrar todos)
        applyFilters();

        // Mostrar interfaz
        document.getElementById('loading').style.display = 'none';
        document.getElementById('contentArea').style.display = 'block';
    };

    // 3. LLENAR DROPDOWNS DE NOMBRES
    function populateNameDropdowns() {
        const selEsposo = document.getElementById('filterEsposo');
        const selEsposa = document.getElementById('filterEsposa');
        
        const listEsposos = [...new Set(allData.map(r => r[COL_ESPOSO]))].filter(Boolean).sort();
        const listEsposas = [...new Set(allData.map(r => r[COL_ESPOSA]))].filter(Boolean).sort();

        listEsposos.forEach(n => selEsposo.add(new Option(n, n)));
        listEsposas.forEach(n => selEsposa.add(new Option(n, n)));
    }

    // 4. L√ìGICA DE FILTRADO MAESTRO
    function applyFilters(changedSource) {
        // Obtener valores de los filtros
        const valPago = document.getElementById('filterPago').value;
        const valCheckIn = document.getElementById('filterCheckIn').value;
        let valEsposo = document.getElementById('filterEsposo').value;
        let valEsposa = document.getElementById('filterEsposa').value;

        // L√≥gica de sincronizaci√≥n de pareja (si seleccionas esposo, se selecciona esposa)
        if (changedSource === 'esposo' && valEsposo) {
            const match = allData.find(r => r[COL_ESPOSO] === valEsposo);
            if (match) {
                valEsposa = match[COL_ESPOSA];
                document.getElementById('filterEsposa').value = valEsposa;
            }
        } else if (changedSource === 'esposa' && valEsposa) {
            const match = allData.find(r => r[COL_ESPOSA] === valEsposa);
            if (match) {
                valEsposo = match[COL_ESPOSO];
                document.getElementById('filterEsposo').value = valEsposo;
            }
        }

        // --- FILTRADO ---
        filteredData = allData.filter(row => {
            let passPago = true;
            let passCheckIn = true;
            let passNombres = true;

            // A. Filtro de Pago
            const estadoPago = (row[COL_PAGO] || "").toString().toLowerCase().trim();
            if (valPago === 'pendientes') {
                // Pasa si est√° vac√≠o O no dice "pagado"
                passPago = (estadoPago === "");
            } else if (valPago === 'pagados') {
                passPago = estadoPago.includes("pagado");
            }

            // B. Filtro de Check-in
            const estadoCheckIn = (row[COL_CHECKIN] || "").toString().toLowerCase().trim();
            // Si es "default", ignoramos este filtro (pasa todo)
            if (valCheckIn !== 'default' && valCheckIn !== 'todos') {
                if (valCheckIn === 'confirmado') {
                    passCheckIn = estadoCheckIn.includes("ok") || estadoCheckIn.includes("confirmada");
                } else if (valCheckIn === 'sin_confirmar') {
                    passCheckIn = (estadoCheckIn === "");
                }
            }

            // C. Filtro de Nombres
            if (valEsposo && row[COL_ESPOSO] !== valEsposo) passNombres = false;
            if (valEsposa && row[COL_ESPOSA] !== valEsposa) passNombres = false;

            return passPago && passCheckIn && passNombres;
        });

        // Actualizar contador
        document.getElementById('recordCount').innerText = `Registros encontrados: ${filteredData.length}`;
        
        // Dibujar tabla
        renderTable();
    }

    // 5. DIBUJAR TABLA
    function renderTable() {
        const thead = document.getElementById('tableHead');
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = ''; 
        thead.innerHTML = '';

        // Encabezados (Mostrar solo columnas relevantes para admin)
        // Mostramos las primeras 4 (Timestamp, Nombres, Tel) + Pago + CheckIn
        const colsToShow = [0, 1, 2, 3, COL_PAGO, COL_CHECKIN];
        
        colsToShow.forEach(idx => {
            let title = headers[idx] || `Col ${idx}`;
            if(idx === COL_PAGO) title = "Estatus Pago";
            if(idx === COL_CHECKIN) title = "Check-In";
            thead.insertAdjacentHTML('beforeend', `<th>${title}</th>`);
        });

        // Filas
        filteredData.forEach(row => {
            let tr = document.createElement('tr');
            
            colsToShow.forEach(idx => {
                let cellData = row[idx];
                let content = cellData;

                // Formato visual para Pago
                if (idx === COL_PAGO) {
                    let text = (cellData || "").toString().toLowerCase();
                    if (text.includes("pagado")) {
                        content = `<span class="tag tag-pagado">Pagado</span>`;
                    } else {
                        content = `<span class="tag tag-pendiente">Pendiente</span>`;
                    }
                }

                // Formato visual para Check-in
                if (idx === COL_CHECKIN) {
                    let text = (cellData || "").toString().toLowerCase();
                    if (text.includes("ok") || text.includes("confirmada")) {
                        content = `<span class="tag tag-checkin">OK</span>`;
                    } else {
                        content = `<span style="color:#999; font-style:italic;">--</span>`;
                    }
                }

                tr.insertAdjacentHTML('beforeend', `<td>${content}</td>`);
            });
            
            tbody.appendChild(tr);
        });

        if (filteredData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No se encontraron registros con estos filtros.</td></tr>';
        }
    }

    // Iniciar
    loadDatabase();

</script>

</body>
</html>
