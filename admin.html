<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>Admin - Control Boda</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f8; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .controls { display: flex; gap: 20px; flex-wrap: wrap; background: #eef2f6; padding: 20px; border-radius: 8px; margin-bottom: 20px; justify-content: center; }
        .control-group { flex: 1; min-width: 250px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; }
        select { width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #ccc; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; display: none; }
        th { background: #34495e; color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }

        /* Bot√≥n WhatsApp */
        .btn-whatsapp {
            background-color: #25D366; color: white; border: none; padding: 12px; border-radius: 6px;
            cursor: pointer; font-weight: bold; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1rem;
        }
        .btn-whatsapp:hover { background-color: #1ebc57; }
        .btn-whatsapp:disabled { background-color: #ccc; cursor: not-allowed; }

        .status-paid { color: #27ae60; font-weight: bold; background: #e8f8f5; padding: 8px; border-radius: 20px; text-align: center; margin-top: 10px; border: 1px solid #a9dfbf; }
        #loading { text-align: center; padding: 40px; font-size: 1.2rem; color: #666; }
        .ver-num { font-size: 0.8em; color: #999; text-align: right; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üíç Panel de Control</h2>
    <div id="loading">‚è≥ Cargando base de datos...</div>

    <div class="controls" id="mainControls" style="display:none;">
        <div class="control-group">
            <label>ü§µ Esposo:</label>
            <select id="selectEsposo" onchange="filterData('esposo')"><option value="">-- Seleccionar --</option></select>
        </div>
        <div class="control-group">
            <label>üë∞ Esposa:</label>
            <select id="selectEsposa" onchange="filterData('esposa')"><option value="">-- Seleccionar --</option></select>
        </div>
    </div>

    <table id="dataTable">
        <thead><tr id="tableHead"></tr></thead>
        <tbody id="tableBody"></tbody>
    </table>
    
    <div class="ver-num" id="versionTag"></div>
</div>

<script>
    // --- TUS URLs ---
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxV9Xrkhp_sXg3flJj1FcyOPe0Is8fb7pOWhRoMg7Yz2ZOzK8d0PTDdllPpDPM2lU1-Hg/exec"; 
    const URL_PASE_BASE = "https://dmendocci.github.io/cena-parejas/pase.html";

    // Configuraci√≥n Hoja
    const SHEET_ID = '1U34XStgMUyf_FquxntWjGOG5QHsCnKrAaAiMEEQCFzQ';
    const SHEET_GID = '1718744959';
    const COL_ESPOSO = 1;
    const COL_ESPOSA = 2;
    const COL_TELEFONO = 3; // Columna D (Indice 3)
    const COL_ESTADO = 6;   // Columna G (√çndice 6)
    const COL_LINK = 9;     // Columna J (√çndice 9)

    let allData = [];
    let headers = [];

    // --- Carga Inicial con Anti-Cach√© ---
    function loadDatabase() {
        // Generamos n√∫mero aleatorio para que SIEMPRE traiga datos nuevos
        const t = new Date().getTime();
        document.getElementById('versionTag').innerText = "v." + t; // Para ver si actualiz√≥
        const script = document.createElement('script');
        script.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:processData&gid=${SHEET_GID}&t=${t}`;
        document.body.appendChild(script);
    }

    window.processData = function(json) {
        headers = json.table.cols.map(c => c.label || "Col");
        allData = json.table.rows.map(r => r.c.map(c => (c && c.v !== null) ? c.v : ""));
        populateDropdowns();
        document.getElementById('loading').style.display = 'none';
        document.getElementById('mainControls').style.display = 'flex';
    };

    function populateDropdowns() {
        const s1 = document.getElementById('selectEsposo');
        const s2 = document.getElementById('selectEsposa');
        s1.innerHTML = '<option value="">-- Seleccionar --</option>';
        s2.innerHTML = '<option value="">-- Seleccionar --</option>';
        
        [...new Set(allData.map(r => r[COL_ESPOSO]))].filter(Boolean).sort().forEach(x => s1.add(new Option(x, x)));
        [...new Set(allData.map(r => r[COL_ESPOSA]))].filter(Boolean).sort().forEach(x => s2.add(new Option(x, x)));
    }

    function filterData(source) {
        const v1 = document.getElementById('selectEsposo').value;
        const v2 = document.getElementById('selectEsposa').value;
        let match = null;
        if (source === 'esposo' && v1) match = allData.find(r => r[COL_ESPOSO] === v1);
        else if (source === 'esposa' && v2) match = allData.find(r => r[COL_ESPOSA] === v2);
        
        if(match) {
            if(source==='esposo') document.getElementById('selectEsposa').value = match[COL_ESPOSA];
            else document.getElementById('selectEsposo').value = match[COL_ESPOSO];
        }
        renderTable(match);
    }

    function renderTable(row) {
        const tbl = document.getElementById('dataTable');
        const thead = document.getElementById('tableHead');
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = ''; thead.innerHTML = '';
        
        if (!row) { tbl.style.display = 'none'; return; }
        tbl.style.display = 'table';

        headers.forEach(h => thead.insertAdjacentHTML('beforeend', `<th>${h}</th>`));
        thead.insertAdjacentHTML('beforeend', `<th style="text-align:center">Acci√≥n</th>`);

        let tr = document.createElement('tr');
        row.forEach(c => tr.insertAdjacentHTML('beforeend', `<td>${c}</td>`));

        let tdAction = document.createElement('td');
        const estado = (row[COL_ESTADO] || "").toString().toLowerCase();
        const isPaid = estado.includes("pagado");

        // --- SOLUCI√ìN AL PROBLEMA "REGENERANDO" ---
        // Construimos el link SIEMPRE aqu√≠, no dependemos de si la hoja lo guard√≥ o no.
        const linkCalculado = generarLinkLocal(row[COL_ESPOSO], row[COL_ESPOSA]);

        if (isPaid) {
            let btn = document.createElement('button');
            btn.className = 'btn-whatsapp';
            btn.innerHTML = 'üì≤ Reenviar WhatsApp';
            // Usamos el link calculado inmediatamente
            btn.onclick = () => openWhatsApp(row, linkCalculado);
            tdAction.appendChild(btn);
            
            let status = document.createElement('div');
            status.className = 'status-paid';
            status.innerText = "‚úÖ PAGADO";
            tdAction.appendChild(status);
        } else {
            let btn = document.createElement('button');
            btn.className = 'btn-whatsapp';
            btn.innerHTML = '‚úÖ Validar y Enviar Link';
            btn.onclick = () => validateAndSend(btn, row, tdAction);
            tdAction.appendChild(btn);
        }
        tr.appendChild(tdAction);
        tbody.appendChild(tr);
    }

    // --- FUNCI√ìN PARA CREAR EL LINK ---
    function generarLinkLocal(esposo, esposa) {
        return URL_PASE_BASE + "?esposo=" + encodeURIComponent(esposo) + "&esposa=" + encodeURIComponent(esposa);
    }

    function validateAndSend(btn, row, container) {
        btn.disabled = true;
        btn.innerText = "‚è≥ Registrando...";

        // 1. Calculamos el link YA MISMO (No esperamos a Google)
        const linkFinal = generarLinkLocal(row[COL_ESPOSO], row[COL_ESPOSA]);

        const params = new URLSearchParams();
        params.append('accion', 'pagar');
        params.append('esposo', row[COL_ESPOSO]);
        params.append('esposa', row[COL_ESPOSA]);

        // 2. Enviamos a Google para que guarde (en segundo plano)
        fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params
        }).then(() => {
            setTimeout(() => {
                // 3. Abrimos WhatsApp con el link que CALCULAMOS nosotros
                openWhatsApp(row, linkFinal);
                
                // Actualizar UI
                container.innerHTML = '';
                let badge = document.createElement('div');
                badge.className = 'status-paid';
                badge.innerText = "‚úÖ LISTO";
                container.appendChild(badge);
                
                // Actualizar memoria local para que no pida validar de nuevo
                row[COL_ESTADO] = "Pagado";
                row[COL_LINK] = linkFinal;

            }, 1000); // 1 segundo de espera por est√©tica
        }).catch(err => {
            alert("Error de conexi√≥n");
            btn.disabled = false;
        });
    }

    function openWhatsApp(row, linkUrl) {
        let telefono = (row[COL_TELEFONO] || "").toString().replace(/\D/g, ''); 
        
        // Mensaje limpio
        const mensaje = `¬°Hola! Su asistencia a la boda ha sido confirmada.\n\nPor favor, presenten este c√≥digo QR en la entrada:\n${linkUrl}\n\n¬°Los esperamos!`;
        
        let waUrl = `https://web.whatsapp.com/send?text=${encodeURIComponent(mensaje)}`;
        if (telefono.length > 5) {
            waUrl += `&phone=${telefono}`;
        }
        
        window.open(waUrl, '_blank');
    }

    loadDatabase();
</script>

</body>
</html>
